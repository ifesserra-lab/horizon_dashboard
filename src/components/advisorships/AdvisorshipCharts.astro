---
interface Props {
    analytics: {
        status_distribution: { label: string; value: number; color: string }[];
        fellowship_distribution: {
            label: string;
            value: number;
            color: string;
        }[];
        fellowship_evolution: {
             label: string;
             data: { year: number; value: number }[];
             color: string;
        }[]; 
        top_supervisors: { name: string; count: number }[];
    };
}

const { analytics } = Astro.props;

const totalStatus = analytics.status_distribution.reduce(
    (acc, curr) => acc + curr.value,
    0,
);
const totalFellowships = analytics.fellowship_distribution.reduce(
    (acc, curr) => acc + curr.value,
    0,
);
const maxSupervisorCount =
    analytics.top_supervisors.length > 0
        ? analytics.top_supervisors[0].count
        : 1;
---

<div class="space-y-6">
    <!-- Tabs Header -->
    <div
        class="flex items-center justify-between border-b border-border-main/50 pb-px overflow-x-auto no-scrollbar"
    >
        <div
            class="flex gap-4 md:gap-8"
            role="tablist"
            aria-label="Visualizações analíticas"
        >
            <button
                role="tab"
                aria-selected="true"
                aria-controls="panel-general"
                id="tab-general"
                class="pb-3 md:pb-4 text-xs md:text-sm font-bold tracking-wide transition-all relative group cursor-pointer text-premium-accent border-b-2 border-premium-accent whitespace-nowrap"
            >
                <span class="hidden sm:inline">Visão Geral</span>
                <span class="sm:hidden">Geral</span>
            </button>
            <button
                role="tab"
                aria-selected="false"
                aria-controls="panel-fellowships"
                id="tab-fellowships"
                class="pb-3 md:pb-4 text-xs md:text-sm font-bold tracking-wide transition-all relative group cursor-pointer text-text-muted hover:text-text-main border-b-2 border-transparent whitespace-nowrap"
            >
                <span class="hidden sm:inline">Evolução de Bolsas</span>
                <span class="sm:hidden">Bolsas</span>
            </button>
            <button
                role="tab"
                aria-selected="false"
                aria-controls="panel-supervisors"
                id="tab-supervisors"
                class="pb-3 md:pb-4 text-xs md:text-sm font-bold tracking-wide transition-all relative group cursor-pointer text-text-muted hover:text-text-main border-b-2 border-transparent whitespace-nowrap"
            >
                <span class="hidden sm:inline">Top Orientadores</span>
                <span class="sm:hidden">Orientadores</span>
            </button>
        </div>
    </div>

    <!-- Tab Panels Container -->
    <div class="relative min-h-[400px]">
        <!-- 1. General Status Panel -->
        <div
            id="panel-general"
            role="tabpanel"
            aria-labelledby="tab-general"
            class="transition-all duration-300 opacity-100 scale-100"
        >
            <div
                class="glass-card p-8 flex flex-col md:flex-row items-center justify-center gap-12 min-h-[350px]"
            >
                <div class="relative w-64 h-64 flex-shrink-0">
                    <svg viewBox="0 0 36 36" class="w-full h-full -rotate-90">
                        {
                            (() => {
                                let currentOffset = 0;
                                return analytics.status_distribution.map(
                                    (item) => {
                                        const percentage =
                                            totalStatus > 0
                                                ? (item.value / totalStatus) *
                                                  100
                                                : 0;
                                        const dashArray = `${percentage} ${100 - percentage}`;
                                        const offset = -currentOffset;
                                        currentOffset += percentage;
                                        return (
                                            <circle
                                                cx="18"
                                                cy="18"
                                                r="15.915"
                                                fill="transparent"
                                                stroke={item.color}
                                                stroke-width="3"
                                                stroke-dasharray={dashArray}
                                                stroke-dashoffset={offset}
                                                class="transition-all duration-1000 ease-out"
                                            />
                                        );
                                    },
                                );
                            })()
                        }
                    </svg>
                    <div
                        class="absolute inset-0 flex flex-col items-center justify-center"
                    >
                        <span
                            class="text-5xl font-bold font-['Outfit'] text-text-main"
                            >{totalStatus}</span
                        >
                        <span
                            class="text-xs text-text-muted uppercase tracking-[0.2em] font-bold"
                            >Orientações</span
                        >
                    </div>
                </div>
                <div
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6 w-full max-w-xs"
                >
                    {
                        analytics.status_distribution.map((item) => (
                            <div class="glass-card p-4 flex items-center gap-4 bg-white/5 border-white/5">
                                <div
                                    class="w-4 h-4 rounded-full shadow-[0_0_10px_rgba(0,0,0,0.2)]"
                                    style={`background-color: ${item.color}`}
                                />
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-text-main leading-none mb-1">
                                        {item.label}
                                    </span>
                                    <span class="text-xs text-text-muted font-medium">
                                        {item.value} orientações (
                                        {totalStatus > 0
                                            ? Math.round(
                                                  (item.value / totalStatus) *
                                                      100,
                                              )
                                            : 0}
                                        %)
                                    </span>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>

        <!-- 2. Fellowships Panel (Evolution) -->
        <div
            id="panel-fellowships"
            role="tabpanel"
            aria-labelledby="tab-fellowships"
            class="hidden transition-all duration-300 opacity-0 scale-95"
        >
             <div class="glass-card p-8 flex flex-col min-h-[450px]">
                <div class="flex items-center gap-3 mb-8">
                     <div class="w-10 h-10 rounded-xl bg-sky-500/10 flex items-center justify-center text-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                     </div>
                     <div>
                        <h2 class="text-xl font-bold font-['Outfit'] text-text-main">
                            Evolução de Bolsas Ativas
                        </h2>
                        <p class="text-sm text-text-muted">
                            Número de bolsas de pesquisa ativas por ano
                        </p>
                     </div>
                </div>

                <div class="flex-1 w-full h-[350px] relative">
                    {(() => {
                        const seriesList = analytics.fellowship_evolution;
                        if (!seriesList || seriesList.length === 0) return <p class="text-center text-text-muted mt-12">Sem dados históricos disponíveis.</p>;
                        
                        // Calculate max value across all series to normalize Y axis
                        const allValues = seriesList.flatMap(s => s?.data?.map(d => d.value) || []);
                        const maxValue = Math.max(...allValues, 1); // Ensure at least 1 to avoid division by zero
                        
                        // Assume all series have same years range for X axis simplification
                        // In production might need to normalize x-axis if ranges differ, but here we forced same range in index.astro
                        const sampleData = seriesList[0]?.data || [];
                        if (sampleData.length === 0) return <p class="text-center text-text-muted mt-12">Dados insuficientes para gerar o gráfico.</p>;
                        
                        const paddingX = 40;
                        const paddingY = 30;
                        const width = 800; // viewBox width
                        const height = 350; // viewBox height
                        const graphHeight = height - paddingY * 2;
                        const graphWidth = width - paddingX * 2;

                        return (
                            <div class="w-full h-full flex flex-col">
                                <!-- Legend -->
                                <div class="flex flex-wrap justify-center gap-4 mb-4">
                                    {seriesList.map(s => (
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full" style={`background-color: ${s!.color}`}></div>
                                            <span class="text-xs font-bold text-text-secondary">{s!.label}</span>
                                        </div>
                                    ))}
                                </div>

                                <svg viewBox={`0 0 ${width} ${height}`} class="w-full h-full overflow-visible">
                                     <!-- Grid Lines (Horizontal) -->
                                     {[0, 0.25, 0.5, 0.75, 1].map((tick) => {
                                        const y = height - paddingY - tick * graphHeight;
                                        return (
                                            <g>
                                                <line x1={paddingX} y1={y} x2={width - paddingX} y2={y} stroke="currentColor" class="text-border-main" stroke-dasharray="4 4" opacity="0.3" />
                                                <text x={paddingX - 10} y={y + 4} text-anchor="end" class="text-[10px] fill-text-muted font-mono">{Math.round(tick * maxValue)}</text>
                                            </g>
                                        );
                                     })}

                                     <!-- Series -->
                                     {seriesList.map((series) => {
                                         if (!series) return null;
                                         const points = series.data.map((d, i) => {
                                            const x = paddingX + (i / (series.data.length - 1)) * graphWidth;
                                            const y = height - paddingY - (d.value / maxValue) * graphHeight;
                                            return `${x},${y}`;
                                         }).join(" ");

                                         return (
                                            <g>
                                                <!-- Line -->
                                                <polyline 
                                                    points={points} 
                                                    fill="none" 
                                                    stroke={series.color} 
                                                    stroke-width="2" 
                                                    stroke-linecap="round" 
                                                    stroke-linejoin="round"
                                                    class="hover:stroke-[3px] transition-all duration-300"
                                                />
                                                
                                                <!-- Points and Labels -->
                                                {series.data.map((d, i) => {
                                                     if (d.value === 0) return null; // Don't show confusing 0 points/labels? Or maybe just small dot.
                                                     const x = paddingX + (i / (series.data.length - 1)) * graphWidth;
                                                     const y = height - paddingY - (d.value / maxValue) * graphHeight;
                                                     return (
                                                         <g class="group">
                                                            <circle cx={x} cy={y} r="3" fill={series.color} class="stroke-glass-bg stroke-2" />
                                                            <!-- Value Label -->
                                                            <text 
                                                                x={x} 
                                                                y={y - 8} 
                                                                text-anchor="middle" 
                                                                fill={series.color}
                                                                class="text-[10px] font-bold opacity-80 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                {d.value}
                                                            </text>
                                                         </g>
                                                     );
                                                })}
                                            </g>
                                         );
                                     })}

                                     <!-- X Axis Labels (Years) -->
                                     {sampleData.map((d, i) => {
                                         const x = paddingX + (i / (sampleData.length - 1)) * graphWidth;
                                         return (
                                             <text x={x} y={height - paddingY + 20} text-anchor="middle" class="text-[10px] fill-text-muted font-bold">
                                                 {d.year}
                                             </text>
                                         );
                                     })}
                                </svg>
                            </div>
                        );
                    })()}
                </div>
            </div>
        </div>

        <!-- 3. Top Supervisors Panel -->
        <div
            id="panel-supervisors"
            role="tabpanel"
            aria-labelledby="tab-supervisors"
            class="hidden transition-all duration-300 opacity-0 scale-95"
        >
            <div class="glass-card p-8 flex flex-col min-h-[450px]">
                <div class="flex items-center gap-3 mb-8">
                    <div
                        class="w-10 h-10 rounded-xl bg-premium-accent/10 flex items-center justify-center text-premium-accent"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-6 h-6"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"
                            ></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div>
                        <h2
                            class="text-xl font-bold font-['Outfit'] text-text-main"
                        >
                            Top 10 Orientadores
                        </h2>
                        <p class="text-sm text-text-muted">
                            Orientadores com maior número de orientações
                        </p>
                    </div>
                </div>

                <div class="space-y-4">
                    {
                        analytics.top_supervisors.map((sup, index) => {
                            const percentage =
                                (sup.count / maxSupervisorCount) * 100;
                            return (
                                <div class="group">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-3">
                                            <span
                                                class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index < 3 ? "bg-premium-accent text-white shadow-lg shadow-premium-accent/20" : "bg-white/5 text-text-muted"}`}
                                            >
                                                {index + 1}
                                            </span>
                                            <span class="text-sm font-medium text-text-main group-hover:text-premium-accent transition-colors">
                                                {sup.name}
                                            </span>
                                        </div>
                                        <span class="text-sm font-bold text-text-main">
                                            {sup.count}{" "}
                                            <span class="text-xs text-text-muted font-normal">
                                                orientações
                                            </span>
                                        </span>
                                    </div>
                                    <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                                        <div
                                            class="h-full bg-gradient-to-r from-premium-accent to-premium-purple rounded-full relative overflow-hidden group-hover:brightness-110 transition-all duration-500 ease-out"
                                            style={`width: ${percentage}%`}
                                        >
                                            <div class="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000" />
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const setupTabs = () => {
        const tabs = document.querySelectorAll('[role="tab"]');
        const panels = document.querySelectorAll('[role="tabpanel"]');

        tabs.forEach((tab) => {
            tab.addEventListener("click", () => {
                const targetId = tab.getAttribute("aria-controls");

                // Update tab states
                tabs.forEach((t) => {
                    t.setAttribute("aria-selected", "false");
                    t.classList.remove(
                        "text-premium-accent",
                        "border-premium-accent",
                    );
                    t.classList.add("text-text-muted", "border-transparent");
                });
                tab.setAttribute("aria-selected", "true");
                tab.classList.add(
                    "text-premium-accent",
                    "border-premium-accent",
                );
                tab.classList.remove("text-text-muted", "border-transparent");

                // Switch panels
                panels.forEach((panel) => {
                    if (panel.id === targetId) {
                        panel.classList.remove("hidden");
                        setTimeout(() => {
                            panel.classList.add("opacity-100", "scale-100");
                            panel.classList.remove("opacity-0", "scale-95");
                        }, 10);
                    } else {
                        panel.classList.add("hidden", "opacity-0", "scale-95");
                        panel.classList.remove("opacity-100", "scale-100");
                    }
                });
            });
        });
    };

    // Run on first load
    setupTabs();
</script>

<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    [role="tabpanel"] {
        will-change: transform, opacity;
    }

    circle {
        transition: stroke-dashoffset 0.8s ease-in-out;
    }
</style>
