---

---

<div
    id="articlesModal"
    class="fixed inset-0 z-[100] hidden items-center justify-center p-4 sm:p-6"
>
    <div
        class="absolute inset-0 bg-background-main/80 backdrop-blur-md"
        id="modalOverlay"
    >
    </div>
    <div
        class="relative w-full max-w-4xl bg-glass-bg border border-border-main rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] scale-95 opacity-0 transition-all duration-300"
        id="modalContent"
    >
        <!-- Modal Header -->
        <div
            class="p-6 border-b border-border-main flex justify-between items-center bg-premium-purple/5"
        >
            <div>
                <h2
                    class="text-2xl font-bold text-text-main font-['Outfit']"
                    id="modalResearcherName"
                >
                    Pesquisador
                </h2>
                <!-- Small KPIs Container -->
                <div id="modalResearcherKpis" class="flex flex-wrap gap-2 mt-2">
                    <!-- Javascript will populate this -->
                </div>
                <div class="flex gap-4 mt-2" id="modalTabs">
                    <button
                        class="modal-tab-btn active text-sm font-bold border-b-2 border-premium-purple pb-1 text-premium-purple transition-all"
                        data-tab="about"
                    >
                        Sobre
                    </button>
                    <button
                        class="modal-tab-btn text-sm font-bold border-b-2 border-transparent pb-1 text-text-secondary hover:text-text-main transition-all"
                        data-tab="articles"
                    >
                        Artigos
                    </button>
                    <button
                        class="modal-tab-btn text-sm font-bold border-b-2 border-transparent pb-1 text-text-secondary hover:text-text-main transition-all"
                        data-tab="advisorships"
                    >
                        Orientações
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="modalExternalLinks" class="flex gap-2">
                    <!-- Javascript will populate this -->
                </div>
                <button
                    id="closeModal"
                    class="p-2 hover:bg-premium-purple/10 rounded-xl transition-colors text-text-secondary hover:text-premium-purple"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-6 h-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tab Content: About -->
        <div class="flex-1 overflow-y-auto p-8 space-y-6" id="aboutTabContent">
            <div>
                <h3
                    class="text-xs uppercase tracking-widest font-bold text-premium-purple mb-4"
                >
                    Resumo Profissional
                </h3>
                <div
                    id="modalResearcherResume"
                    class="text-sm text-text-main leading-relaxed text-justify opacity-90"
                >
                </div>

                <!-- Client-side Chart Container -->
                <div
                    id="modalResumeChartContainer"
                    class="mt-8 pt-8 border-t border-border-main hidden"
                >
                    <h3
                        class="text-xs uppercase tracking-widest font-bold text-premium-purple mb-4"
                    >
                        Histórico de Publicações
                    </h3>
                    <div id="modalChartWrapper" class="h-40 w-full relative">
                        <!-- SVG Chart will be injected here -->
                    </div>
                </div>
            </div>

            <div
                id="modalTimelineContainer"
                class="mt-8 pt-8 border-t border-border-main hidden"
            >
                <h3
                    class="text-xs uppercase tracking-widest font-bold text-premium-purple mb-4"
                >
                    Trajetória Profissional
                </h3>
                <div id="modalTimeline" class="space-y-6">
                    <!-- Javascript will populate this -->
                </div>
            </div>
        </div>

        <!-- Tab Content: Articles -->
        <div
            class="flex-1 hidden flex-col overflow-hidden"
            id="articlesTabContent"
        >
            <div class="p-4 border-b border-border-main bg-background-main/50">
                <div class="relative">
                    <input
                        type="text"
                        id="articleSearch"
                        placeholder="Filtrar artigos por título..."
                        class="w-full bg-glass-bg border border-border-main rounded-xl px-12 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-premium-purple/50 focus:border-premium-purple transition-all text-text-main"
                    />
                    <svg
                        class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="11" cy="11" r="8"></circle><path
                            d="m21 21-4.3-4.3"></path>
                    </svg>
                </div>
            </div>

            <!-- Articles List -->
            <div
                class="flex-1 overflow-y-auto p-6 space-y-4"
                id="articlesListContainer"
            >
                <div id="articlesList" class="space-y-4"></div>
                <!-- Load More indicator -->
                <div
                    id="loadMoreSentinel"
                    class="h-10 w-full flex items-center justify-center"
                >
                    <div
                        id="loadingSpinner"
                        class="hidden animate-spin rounded-full h-8 w-8 border-4 border-premium-purple border-t-transparent"
                    >
                    </div>
                </div>
                <div
                    id="allLoadedMessage"
                    class="hidden text-center text-text-secondary text-sm py-4 italic"
                >
                    Todos os artigos foram carregados.
                </div>
                <div id="noArticlesFound" class="hidden text-center py-12">
                    <p class="text-text-secondary">
                        Nenhum artigo encontrado para esta busca.
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Advisorships -->
        <div
            class="flex-1 hidden flex-col overflow-hidden p-6"
            id="advisorshipsTabContent"
        >
            <div
                class="overflow-y-auto space-y-4 h-full pr-2"
                id="advisorshipsList"
            >
                <!-- Javascript will populate this -->
            </div>
            <div id="noAdvisorshipsFound" class="hidden text-center py-12">
                <p class="text-text-secondary">
                    Nenhuma orientação encontrada.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // Modal & Articles Logic
    const modal = document.getElementById("articlesModal");
    const modalContent = document.getElementById("modalContent");
    const overlay = document.getElementById("modalOverlay");
    const closeBtn = document.getElementById("closeModal");
    const articlesList = document.getElementById("articlesList");
    const advisorshipsList = document.getElementById("advisorshipsList");
    const articleSearch = document.getElementById(
        "articleSearch",
    ) as HTMLInputElement;
    const spinner = document.getElementById("loadingSpinner");
    const sentinel = document.getElementById("loadMoreSentinel");
    const allLoadedMsg = document.getElementById("allLoadedMessage");
    const noArticlesMsg = document.getElementById("noArticlesFound");
    const noAdvisorshipsMsg = document.getElementById("noAdvisorshipsFound");

    let currentResearcherId: string | null = null; // Changed to string for consistency
    let filteredArticles: any[] = [];
    let displayedCount = 0;
    const BATCH_SIZE = 30;
    let observer: IntersectionObserver | null = null;

    function openModal(id: string, name: string) {
        currentResearcherId = id;
        document.getElementById("modalResearcherName")!.textContent = name;

        const researcher = (window as any).researchersData.find(
            (r: any) => String(r.id) === String(id),
        );
        if (!researcher) return;

        // Update Resume
        const resumeEl = document.getElementById("modalResearcherResume");
        if (resumeEl) {
            resumeEl.textContent =
                researcher.resume && researcher.resume !== "None"
                    ? researcher.resume
                    : "Resumo profissional não disponível.";
        }

        // Render Chart
        renderModalChart(researcher.articles || []);

        // Update KPIs & External Links
        updateHeaderInfo(researcher);

        // Render Timeline
        renderTimeline(researcher);

        // Render Advisorships
        renderAdvisorships(researcher.advisorships || []);

        // Reset tabs
        switchTab("about");

        filteredArticles = researcher.articles || [];

        displayedCount = 0;
        articlesList!.innerHTML = "";
        articleSearch.value = "";

        modal?.classList.remove("hidden");
        modal?.classList.add("flex");

        // Animation
        setTimeout(() => {
            modalContent?.classList.remove("scale-95", "opacity-0");
            modalContent?.classList.add("scale-100", "opacity-100");
        }, 10);

        loadMoreArticles();
        setupInfiniteScroll();

        document.body.style.overflow = "hidden";
    }

    function switchTab(tab: string) {
        const aboutContent = document.getElementById("aboutTabContent");
        const articlesContent = document.getElementById("articlesTabContent");
        const advisorshipsContent = document.getElementById(
            "advisorshipsTabContent",
        );
        const tabBtns = document.querySelectorAll(".modal-tab-btn");

        tabBtns.forEach((btn) => {
            const element = btn as HTMLElement;
            if (element.dataset.tab === tab) {
                element.classList.add(
                    "active",
                    "border-premium-purple",
                    "text-premium-purple",
                );
                element.classList.remove(
                    "border-transparent",
                    "text-text-secondary",
                );
            } else {
                element.classList.remove(
                    "active",
                    "border-premium-purple",
                    "text-premium-purple",
                );
                element.classList.add(
                    "border-transparent",
                    "text-text-secondary",
                );
            }
        });

        // Hide all first
        aboutContent?.classList.add("hidden");
        aboutContent?.classList.remove("flex");
        articlesContent?.classList.add("hidden");
        articlesContent?.classList.remove("flex");
        advisorshipsContent?.classList.add("hidden");
        advisorshipsContent?.classList.remove("flex");

        // Show active
        if (tab === "about") {
            aboutContent?.classList.remove("hidden");
            aboutContent?.classList.add("flex");
        } else if (tab === "articles") {
            articlesContent?.classList.remove("hidden");
            articlesContent?.classList.add("flex");
        } else if (tab === "advisorships") {
            advisorshipsContent?.classList.remove("hidden");
            advisorshipsContent?.classList.add("flex");
        }
    }

    function updateHeaderInfo(researcher: any) {
        const kpisContainer = document.getElementById("modalResearcherKpis");
        const linksContainer = document.getElementById("modalExternalLinks");
        if (!kpisContainer || !linksContainer) return;

        // Render KPIs
        const articlesCount = researcher.articles?.length || 0;
        const projectsCount = researcher.initiatives?.length || 0;
        const advisorshipsCount = researcher.advisorships?.length || 0;

        kpisContainer.innerHTML = `
            <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-premium-purple/5 border border-premium-purple/10 text-[11px] font-bold text-text-main transition-all group">
                <div class="w-1.5 h-1.5 rounded-full bg-premium-purple shadow-[0_0_6px_rgba(124,58,237,0.4)] group-hover:scale-125 transition-transform"></div>
                ${articlesCount} <span class="text-text-secondary font-medium opacity-60">Artigos</span>
            </div>
            <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-premium-accent/5 border border-premium-accent/10 text-[11px] font-bold text-text-main transition-all group">
                <div class="w-1.5 h-1.5 rounded-full bg-premium-accent shadow-[0_0_6px_rgba(2,132,199,0.4)] group-hover:scale-125 transition-transform"></div>
                ${projectsCount} <span class="text-text-secondary font-medium opacity-60">Projetos</span>
            </div>
            <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-amber-500/5 border border-amber-500/10 text-[11px] font-bold text-text-main transition-all group">
                <div class="w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_6px_rgba(245,158,11,0.4)] group-hover:scale-125 transition-transform"></div>
                ${advisorshipsCount} <span class="text-text-secondary font-medium opacity-60">Orientações</span>
            </div>
        `;

        // Render Links
        linksContainer.innerHTML = "";
        if (researcher.lattes_url && researcher.lattes_url !== "None") {
            linksContainer.innerHTML += `
                <a href="${researcher.lattes_url}" target="_blank" class="p-2 bg-slate-500/5 hover:bg-slate-500/10 rounded-xl text-text-secondary hover:text-text-main transition-all" title="Ver Currículo Lattes">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5z"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M12 2v20"/></svg>
                </a>
            `;
        }
        if (researcher.email && researcher.email !== "None") {
            linksContainer.innerHTML += `
                <a href="mailto:${researcher.email}" class="p-2 bg-slate-500/5 hover:bg-slate-500/10 rounded-xl text-text-secondary hover:text-text-main transition-all" title="Enviar Email">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                </a>
            `;
        }
    }

    function renderTimeline(researcher: any) {
        const container = document.getElementById("modalTimelineContainer");
        const timelineEl = document.getElementById("modalTimeline");
        if (!container || !timelineEl) return;

        const events: any[] = [];

        // Add Education
        if (researcher.education && Array.isArray(researcher.education)) {
            researcher.education.forEach((edu: any) => {
                events.push({
                    year: edu.year || edu.end_year,
                    title: edu.degree || edu.title,
                    description: edu.institution,
                    type: "education",
                });
            });
        }

        // Add Projects
        if (researcher.initiatives && Array.isArray(researcher.initiatives)) {
            researcher.initiatives.forEach((proj: any) => {
                events.push({
                    year: proj.start_date
                        ? proj.start_date.split("-")[0]
                        : null,
                    title: proj.title,
                    description: proj.nature,
                    type: "project",
                    status: proj.status,
                });
            });
        }

        // Add Advisorships
        if (researcher.advisorships && Array.isArray(researcher.advisorships)) {
            researcher.advisorships.forEach((adv: any) => {
                events.push({
                    year: adv.start_year,
                    title: `Orientação: ${adv.student_name}`,
                    description: adv.type,
                    type: "advisorship",
                    status: adv.status,
                });
            });
        }

        if (events.length === 0) {
            container.classList.add("hidden");
            return;
        }

        container.classList.remove("hidden");

        // Sort by year desc
        const sortedEvents = events
            .filter((e) => e.year && e.year !== "None")
            .sort((a, b) => parseInt(b.year) - parseInt(a.year));

        timelineEl.innerHTML = "";

        sortedEvents.forEach((event) => {
            const eventDiv = document.createElement("div");
            eventDiv.className =
                "relative pl-8 pb-8 last:pb-0 border-l border-border-main ml-2";

            let icon = "";
            if (event.type === "education") {
                icon = `<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /></svg>`;
            } else if (event.type === "project") {
                icon = `<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>`;
            } else {
                icon = `<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
            }

            const statusHtml =
                event.status && event.status !== "None"
                    ? `<div class="mt-2 flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full ${event.status.toLowerCase().includes("active") || event.status.toLowerCase().includes("progress") || event.status.toLowerCase().includes("running") ? "bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" : "bg-slate-400"}"></span>
                    <span class="text-[9px] uppercase tracking-widest font-bold text-text-secondary opacity-70">${event.status === "Concluded" ? "Concluído" : "Em Andamento"}</span>
                  </div>`
                    : "";

            eventDiv.innerHTML = `
                <div class="absolute -left-[1.05rem] top-0 w-8 h-8 rounded-full border-4 border-background-main bg-glass-bg flex items-center justify-center text-premium-purple z-10 shadow-sm">
                    ${icon}
                </div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-lg font-black font-['Outfit'] text-text-main">${event.year}</span>
                    <span class="px-2 py-0.5 rounded-full bg-premium-purple/10 text-premium-purple text-[9px] font-bold uppercase tracking-wider">
                        ${event.type === "education" ? "Formação" : event.type === "project" ? "Projeto" : "Orientação"}
                    </span>
                </div>
                <h4 class="text-sm font-bold text-text-main leading-snug">${event.title}</h4>
                ${event.description && event.description !== "None" ? `<p class="text-xs text-text-secondary mt-1 opacity-80 italic">${event.description}</p>` : ""}
                ${statusHtml}
            `;
            timelineEl.appendChild(eventDiv);
        });
    }

    function renderAdvisorships(advisorships: any[]) {
        if (!advisorshipsList) return;
        advisorshipsList.innerHTML = "";

        if (!advisorships || advisorships.length === 0) {
            noAdvisorshipsMsg?.classList.remove("hidden");
            return;
        } else {
            noAdvisorshipsMsg?.classList.add("hidden");
        }

        // Sort by year desc (assuming end_year or start_year presence)
        const sorted = [...advisorships].sort((a, b) => {
            const yearA = parseInt(a.end_year) || parseInt(a.start_year) || 0;
            const yearB = parseInt(b.end_year) || parseInt(b.start_year) || 0;
            return yearB - yearA;
        });

        sorted.forEach((adv) => {
            const card = document.createElement("div");
            card.className =
                "p-5 rounded-2xl bg-glass-bg border border-border-main hover:border-premium-purple/30 transition-all group/adv flex flex-col gap-2";

            const statusClass =
                adv.status && adv.status.toLowerCase().includes("concluded")
                    ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-400"
                    : "bg-blue-100 text-blue-700 dark:bg-blue-500/10 dark:text-blue-400";

            const statusText =
                adv.status === "Concluded" ? "Concluído" : "Em Andamento";
            const type =
                adv.type && adv.type !== "None" ? adv.type : "Orientação";

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-2">
                         <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${statusClass}">
                            ${statusText}
                        </span>
                        <span class="text-xs font-bold text-premium-purple uppercase tracking-wider">
                            ${type}
                        </span>
                    </div>
                    <span class="text-xs font-mono font-bold text-text-secondary opacity-70">
                        ${adv.start_year} - ${adv.end_year === "None" ? "Atual" : adv.end_year}
                    </span>
                </div>
                
                <h4 class="text-sm font-bold text-text-main leading-snug">
                    ${adv.name}
                </h4>

                <div class="flex items-center gap-2 mt-1">
                    <div class="w-6 h-6 rounded-full bg-premium-purple/10 flex items-center justify-center text-premium-purple shrink-0">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-text-secondary uppercase tracking-widest">Estudante</span>
                        <span class="text-xs font-medium text-text-main">${adv.student_name}</span>
                    </div>
                </div>
            `;
            advisorshipsList.appendChild(card);
        });
    }

    function closeModalFunc() {
        modalContent?.classList.add("scale-95", "opacity-0");
        modalContent?.classList.remove("scale-100", "opacity-100");

        setTimeout(() => {
            modal?.classList.add("hidden");
            modal?.classList.remove("flex");
            document.body.style.overflow = "";
            if (observer) observer.disconnect();
        }, 300);
    }

    function renderModalChart(articles: any[]) {
        const container = document.getElementById("modalResumeChartContainer");
        const wrapper = document.getElementById("modalChartWrapper");

        if (!articles || articles.length === 0) {
            container?.classList.add("hidden");
            return;
        }

        const yearMap = new Map();
        articles.forEach((article) => {
            const yearStr = String(article.year).trim();
            const year = parseInt(yearStr, 10);
            if (!isNaN(year) && year > 1900 && year < 2100) {
                yearMap.set(year, (yearMap.get(year) || 0) + 1);
            }
        });

        if (yearMap.size === 0) {
            container?.classList.add("hidden");
            return;
        }

        container?.classList.remove("hidden");

        const yearData = Array.from(yearMap.entries())
            .sort((a, b) => a[0] - b[0])
            .map(([year, count]) => ({ year, count }));

        const minYear = yearData[0].year;
        const maxYear = yearData[yearData.length - 1].year;

        const continuousData = [];
        for (let y = minYear; y <= maxYear; y++) {
            continuousData.push({
                year: y,
                count: yearMap.get(y) || 0,
            });
        }

        const maxCount = Math.max(...continuousData.map((d) => d.count), 1);

        let barsHtml = "";
        continuousData.forEach((data) => {
            const height = (data.count / maxCount) * 100;
            barsHtml += `
                <div class="flex-1 flex flex-col items-center group/bar relative h-full justify-end">
                    <div class="absolute bottom-full mb-2 bg-text-main text-background-main text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover/bar:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none shadow-xl border border-white/10">
                        ${data.year}: ${data.count} ${data.count === 1 ? "artigo" : "artigos"}
                    </div>
                    <div class="w-full bg-gradient-to-t from-premium-purple/40 to-premium-purple hover:to-premium-accent transition-all duration-500 rounded-t-sm" 
                         style="height: ${Math.max(height, 4)}%;"></div>
                </div>
            `;
        });

        wrapper!.innerHTML = `
            <div class="flex items-end justify-between gap-1 h-full w-full group/chart">
                ${barsHtml}
            </div>
            <div class="flex justify-between text-[10px] text-text-secondary mt-4 font-bold font-mono tracking-tighter opacity-80">
                <span>${minYear}</span>
                <span class="text-[9px] font-medium opacity-50 uppercase tracking-widest">Produção Anual</span>
                <span>${maxYear}</span>
            </div>
        `;
    }

    function loadMoreArticles() {
        if (!articlesList) return;
        const nextBatch = filteredArticles.slice(
            displayedCount,
            displayedCount + BATCH_SIZE,
        );

        if (nextBatch.length === 0 && displayedCount === 0) {
            noArticlesMsg?.classList.remove("hidden");
        } else {
            noArticlesMsg?.classList.add("hidden");
        }

        nextBatch.forEach((article) => {
            const articleEl = document.createElement("div");
            articleEl.className =
                "p-5 rounded-2xl bg-glass-bg border border-border-main hover:border-premium-purple/30 transition-all group/article";
            articleEl.innerHTML = `
                <div class="flex justify-between items-start gap-4">
                    <div class="space-y-2 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded-full bg-premium-purple/10 text-premium-purple text-[10px] font-bold uppercase tracking-wider">${article.type}</span>
                            <span class="text-xs font-bold text-text-secondary">${article.year}</span>
                        </div>
                        <h4 class="text-sm font-bold text-text-main leading-snug">${article.title}</h4>
                        <p class="text-xs text-text-secondary flex items-center gap-1.5 italic">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                            ${article.journal_conference}
                        </p>
                    </div>
                    ${
                        article.doi
                            ? `
                        <a href="${article.doi.startsWith("http") ? article.doi : `https://doi.org/${article.doi}`}" 
                           target="_blank" 
                           class="flex-shrink-0 p-2 bg-premium-purple/5 hover:bg-premium-purple/10 rounded-lg text-premium-purple transition-colors"
                           title="Ver DOI">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        </a>
                    `
                            : ""
                    }
                </div>
            `;
            articlesList.appendChild(articleEl);
        });

        displayedCount += BATCH_SIZE;

        if (displayedCount >= filteredArticles.length) {
            allLoadedMsg?.classList.remove("hidden");
            if (observer) observer.disconnect();
        } else {
            allLoadedMsg?.classList.add("hidden");
        }
    }

    function setupInfiniteScroll() {
        if (observer) observer.disconnect();

        observer = new IntersectionObserver(
            (entries) => {
                if (
                    entries[0].isIntersecting &&
                    displayedCount < filteredArticles.length
                ) {
                    spinner?.classList.remove("hidden");
                    setTimeout(() => {
                        loadMoreArticles();
                        spinner?.classList.add("hidden");
                    }, 400);
                }
            },
            { threshold: 1.0 },
        );

        if (sentinel) observer.observe(sentinel);
    }

    function handleArticleSearch() {
        const query = articleSearch.value.toLowerCase().trim();
        const researcher = (window as any).researchersData.find(
            (r: any) => String(r.id) === String(currentResearcherId),
        );
        if (!researcher) return;

        filteredArticles = researcher.articles.filter(
            (a: any) =>
                a.title.toLowerCase().includes(query) ||
                a.journal_conference.toLowerCase().includes(query),
        );

        displayedCount = 0;
        articlesList!.innerHTML = "";
        loadMoreArticles();
        setupInfiniteScroll();
    }

    // Event Listeners
    closeBtn?.addEventListener("click", closeModalFunc);
    overlay?.addEventListener("click", closeModalFunc);
    articleSearch?.addEventListener("input", handleArticleSearch);

    document.querySelectorAll(".modal-tab-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const target = e.currentTarget as HTMLElement;
            switchTab(target.dataset.tab!);
        });
    });

    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
            closeModalFunc();
        }
    });

    // Handle trigger from cards
    window.addEventListener("open-researcher-modal", (e: any) => {
        openModal(e.detail.id, e.detail.name);
    });
</script>
