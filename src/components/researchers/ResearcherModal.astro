---

---

<div
    id="articlesModal"
    class="fixed inset-0 z-[100] hidden items-center justify-center p-4 sm:p-6"
>
    <div
        class="absolute inset-0 bg-background-main/80 backdrop-blur-md"
        id="modalOverlay"
    >
    </div>
    <div
        class="relative w-full max-w-4xl bg-glass-bg border border-border-main rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] scale-95 opacity-0 transition-all duration-300"
        id="modalContent"
    >
        <!-- Modal Header -->
        <div
            class="p-6 border-b border-border-main flex justify-between items-center bg-premium-purple/5"
        >
            <div>
                <h2
                    class="text-2xl font-bold text-text-main font-['Outfit']"
                    id="modalResearcherName"
                >
                    Pesquisador
                </h2>
                <div class="flex gap-4 mt-2" id="modalTabs">
                    <button
                        class="modal-tab-btn active text-sm font-bold border-b-2 border-premium-purple pb-1 text-premium-purple transition-all"
                        data-tab="about"
                    >
                        Sobre
                    </button>
                    <button
                        class="modal-tab-btn text-sm font-bold border-b-2 border-transparent pb-1 text-text-secondary hover:text-text-main transition-all"
                        data-tab="articles"
                    >
                        Artigos
                    </button>
                </div>
            </div>
            <button
                id="closeModal"
                class="p-2 hover:bg-premium-purple/10 rounded-xl transition-colors text-text-secondary hover:text-premium-purple"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Tab Content: About -->
        <div class="flex-1 overflow-y-auto p-8 space-y-6" id="aboutTabContent">
            <div>
                <h3
                    class="text-xs uppercase tracking-widest font-bold text-premium-purple mb-4"
                >
                    Resumo Profissional
                </h3>
                <div
                    id="modalResearcherResume"
                    class="text-sm text-text-main leading-relaxed text-justify opacity-90"
                >
                </div>

                <!-- Client-side Chart Container -->
                <div
                    id="modalResumeChartContainer"
                    class="mt-8 pt-8 border-t border-border-main hidden"
                >
                    <h3
                        class="text-xs uppercase tracking-widest font-bold text-premium-purple mb-4"
                    >
                        Histórico de Publicações
                    </h3>
                    <div id="modalChartWrapper" class="h-40 w-full relative">
                        <!-- SVG Chart will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Articles -->
        <div
            class="flex-1 hidden flex-col overflow-hidden"
            id="articlesTabContent"
        >
            <div class="p-4 border-b border-border-main bg-background-main/50">
                <div class="relative">
                    <input
                        type="text"
                        id="articleSearch"
                        placeholder="Filtrar artigos por título..."
                        class="w-full bg-glass-bg border border-border-main rounded-xl px-12 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-premium-purple/50 focus:border-premium-purple transition-all text-text-main"
                    />
                    <svg
                        class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="11" cy="11" r="8"></circle><path
                            d="m21 21-4.3-4.3"></path>
                    </svg>
                </div>
            </div>

            <!-- Articles List -->
            <div
                class="flex-1 overflow-y-auto p-6 space-y-4"
                id="articlesListContainer"
            >
                <div id="articlesList" class="space-y-4"></div>
                <!-- Load More indicator -->
                <div
                    id="loadMoreSentinel"
                    class="h-10 w-full flex items-center justify-center"
                >
                    <div
                        id="loadingSpinner"
                        class="hidden animate-spin rounded-full h-8 w-8 border-4 border-premium-purple border-t-transparent"
                    >
                    </div>
                </div>
                <div
                    id="allLoadedMessage"
                    class="hidden text-center text-text-secondary text-sm py-4 italic"
                >
                    Todos os artigos foram carregados.
                </div>
                <div id="noArticlesFound" class="hidden text-center py-12">
                    <p class="text-text-secondary">
                        Nenhum artigo encontrado para esta busca.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Modal & Articles Logic
    const modal = document.getElementById("articlesModal");
    const modalContent = document.getElementById("modalContent");
    const overlay = document.getElementById("modalOverlay");
    const closeBtn = document.getElementById("closeModal");
    const articlesList = document.getElementById("articlesList");
    const articleSearch = document.getElementById(
        "articleSearch",
    ) as HTMLInputElement;
    const spinner = document.getElementById("loadingSpinner");
    const sentinel = document.getElementById("loadMoreSentinel");
    const allLoadedMsg = document.getElementById("allLoadedMessage");
    const noArticlesMsg = document.getElementById("noArticlesFound");

    let currentResearcherId: string | null = null; // Changed to string for consistency
    let filteredArticles: any[] = [];
    let displayedCount = 0;
    const BATCH_SIZE = 30;
    let observer: IntersectionObserver | null = null;

    function openModal(id: string, name: string) {
        currentResearcherId = id;
        document.getElementById("modalResearcherName")!.textContent = name;

        const researcher = (window as any).researchersData.find(
            (r: any) => String(r.id) === String(id),
        );
        if (!researcher) return;

        // Update Resume
        const resumeEl = document.getElementById("modalResearcherResume");
        if (resumeEl) {
            resumeEl.textContent =
                researcher.resume && researcher.resume !== "None"
                    ? researcher.resume
                    : "Resumo profissional não disponível.";
        }

        // Render Chart
        renderModalChart(researcher.articles || []);

        // Reset tabs
        switchTab("about");

        filteredArticles = researcher.articles || [];

        displayedCount = 0;
        articlesList!.innerHTML = "";
        articleSearch.value = "";

        modal?.classList.remove("hidden");
        modal?.classList.add("flex");

        // Animation
        setTimeout(() => {
            modalContent?.classList.remove("scale-95", "opacity-0");
            modalContent?.classList.add("scale-100", "opacity-100");
        }, 10);

        loadMoreArticles();
        setupInfiniteScroll();

        document.body.style.overflow = "hidden";
    }

    function switchTab(tab: string) {
        const aboutContent = document.getElementById("aboutTabContent");
        const articlesContent = document.getElementById("articlesTabContent");
        const tabBtns = document.querySelectorAll(".modal-tab-btn");

        tabBtns.forEach((btn) => {
            const element = btn as HTMLElement;
            if (element.dataset.tab === tab) {
                element.classList.add(
                    "active",
                    "border-premium-purple",
                    "text-premium-purple",
                );
                element.classList.remove(
                    "border-transparent",
                    "text-text-secondary",
                );
            } else {
                element.classList.remove(
                    "active",
                    "border-premium-purple",
                    "text-premium-purple",
                );
                element.classList.add(
                    "border-transparent",
                    "text-text-secondary",
                );
            }
        });

        if (tab === "about") {
            aboutContent?.classList.remove("hidden");
            aboutContent?.classList.add("flex");
            articlesContent?.classList.add("hidden");
            articlesContent?.classList.remove("flex");
        } else {
            aboutContent?.classList.add("hidden");
            aboutContent?.classList.remove("flex");
            articlesContent?.classList.remove("hidden");
            articlesContent?.classList.add("flex");
        }
    }

    function closeModalFunc() {
        modalContent?.classList.add("scale-95", "opacity-0");
        modalContent?.classList.remove("scale-100", "opacity-100");

        setTimeout(() => {
            modal?.classList.add("hidden");
            modal?.classList.remove("flex");
            document.body.style.overflow = "";
            if (observer) observer.disconnect();
        }, 300);
    }

    function renderModalChart(articles: any[]) {
        const container = document.getElementById("modalResumeChartContainer");
        const wrapper = document.getElementById("modalChartWrapper");

        if (!articles || articles.length === 0) {
            container?.classList.add("hidden");
            return;
        }

        const yearMap = new Map();
        articles.forEach((article) => {
            const yearStr = String(article.year).trim();
            const year = parseInt(yearStr, 10);
            if (!isNaN(year) && year > 1900 && year < 2100) {
                yearMap.set(year, (yearMap.get(year) || 0) + 1);
            }
        });

        if (yearMap.size === 0) {
            container?.classList.add("hidden");
            return;
        }

        container?.classList.remove("hidden");

        const yearData = Array.from(yearMap.entries())
            .sort((a, b) => a[0] - b[0])
            .map(([year, count]) => ({ year, count }));

        const minYear = yearData[0].year;
        const maxYear = yearData[yearData.length - 1].year;

        const continuousData = [];
        for (let y = minYear; y <= maxYear; y++) {
            continuousData.push({
                year: y,
                count: yearMap.get(y) || 0,
            });
        }

        const maxCount = Math.max(...continuousData.map((d) => d.count), 1);

        let barsHtml = "";
        continuousData.forEach((data) => {
            const height = (data.count / maxCount) * 100;
            barsHtml += `
                <div class="flex-1 flex flex-col items-center group/bar relative h-full justify-end">
                    <div class="absolute bottom-full mb-2 bg-text-main text-background-main text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover/bar:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none shadow-xl border border-white/10">
                        ${data.year}: ${data.count} ${data.count === 1 ? "artigo" : "artigos"}
                    </div>
                    <div class="w-full bg-gradient-to-t from-premium-purple/40 to-premium-purple hover:to-premium-accent transition-all duration-500 rounded-t-sm" 
                         style="height: ${Math.max(height, 4)}%;"></div>
                </div>
            `;
        });

        wrapper!.innerHTML = `
            <div class="flex items-end justify-between gap-1 h-full w-full group/chart">
                ${barsHtml}
            </div>
            <div class="flex justify-between text-[10px] text-text-secondary mt-4 font-bold font-mono tracking-tighter opacity-80">
                <span>${minYear}</span>
                <span class="text-[9px] font-medium opacity-50 uppercase tracking-widest">Produção Anual</span>
                <span>${maxYear}</span>
            </div>
        `;
    }

    function loadMoreArticles() {
        if (!articlesList) return;
        const nextBatch = filteredArticles.slice(
            displayedCount,
            displayedCount + BATCH_SIZE,
        );

        if (nextBatch.length === 0 && displayedCount === 0) {
            noArticlesMsg?.classList.remove("hidden");
        } else {
            noArticlesMsg?.classList.add("hidden");
        }

        nextBatch.forEach((article) => {
            const articleEl = document.createElement("div");
            articleEl.className =
                "p-5 rounded-2xl bg-glass-bg border border-border-main hover:border-premium-purple/30 transition-all group/article";
            articleEl.innerHTML = `
                <div class="flex justify-between items-start gap-4">
                    <div class="space-y-2 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded-full bg-premium-purple/10 text-premium-purple text-[10px] font-bold uppercase tracking-wider">${article.type}</span>
                            <span class="text-xs font-bold text-text-secondary">${article.year}</span>
                        </div>
                        <h4 class="text-sm font-bold text-text-main leading-snug">${article.title}</h4>
                        <p class="text-xs text-text-secondary flex items-center gap-1.5 italic">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                            ${article.journal_conference}
                        </p>
                    </div>
                    ${
                        article.doi
                            ? `
                        <a href="${article.doi.startsWith("http") ? article.doi : `https://doi.org/${article.doi}`}" 
                           target="_blank" 
                           class="flex-shrink-0 p-2 bg-premium-purple/5 hover:bg-premium-purple/10 rounded-lg text-premium-purple transition-colors"
                           title="Ver DOI">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        </a>
                    `
                            : ""
                    }
                </div>
            `;
            articlesList.appendChild(articleEl);
        });

        displayedCount += BATCH_SIZE;

        if (displayedCount >= filteredArticles.length) {
            allLoadedMsg?.classList.remove("hidden");
            if (observer) observer.disconnect();
        } else {
            allLoadedMsg?.classList.add("hidden");
        }
    }

    function setupInfiniteScroll() {
        if (observer) observer.disconnect();

        observer = new IntersectionObserver(
            (entries) => {
                if (
                    entries[0].isIntersecting &&
                    displayedCount < filteredArticles.length
                ) {
                    spinner?.classList.remove("hidden");
                    setTimeout(() => {
                        loadMoreArticles();
                        spinner?.classList.add("hidden");
                    }, 400);
                }
            },
            { threshold: 1.0 },
        );

        if (sentinel) observer.observe(sentinel);
    }

    function handleArticleSearch() {
        const query = articleSearch.value.toLowerCase().trim();
        const researcher = (window as any).researchersData.find(
            (r: any) => String(r.id) === String(currentResearcherId),
        );
        if (!researcher) return;

        filteredArticles = researcher.articles.filter(
            (a: any) =>
                a.title.toLowerCase().includes(query) ||
                a.journal_conference.toLowerCase().includes(query),
        );

        displayedCount = 0;
        articlesList!.innerHTML = "";
        loadMoreArticles();
        setupInfiniteScroll();
    }

    // Event Listeners
    closeBtn?.addEventListener("click", closeModalFunc);
    overlay?.addEventListener("click", closeModalFunc);
    articleSearch?.addEventListener("input", handleArticleSearch);

    document.querySelectorAll(".modal-tab-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const target = e.currentTarget as HTMLElement;
            switchTab(target.dataset.tab!);
        });
    });

    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
            closeModalFunc();
        }
    });

    // Handle trigger from cards
    window.addEventListener("open-researcher-modal", (e: any) => {
        openModal(e.detail.id, e.detail.name);
    });
</script>
