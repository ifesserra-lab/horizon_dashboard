---
import type { Researcher, ResearcherInitiative } from "../../types/researchers";
import ProjectCard from "./ProjectCard.astro";

interface Props {
    researcher: Researcher;
}

const { researcher } = Astro.props;
---

<section aria-labelledby="projects-title" class="space-y-6">
    <h3
        id="projects-title"
        class="text-2xl font-bold font-['Outfit'] text-text-main py-4 border-b border-border-main"
    >
        Projetos e Iniciativas
    </h3>

    {
        (() => {
            // Helper Sort Function
            const sortProjects = (projects: ResearcherInitiative[]) => {
                return projects.sort((a, b) => {
                    // 1. Status: Active comes first
                    const aActive = a.status.toLowerCase() === "active";
                    const bActive = b.status.toLowerCase() === "active";
                    if (aActive && !bActive) return -1;
                    if (!aActive && bActive) return 1;

                    // 2. Date: Newest first
                    const aDate = a.start_date
                        ? new Date(a.start_date).getTime()
                        : 0;
                    const bDate = b.start_date
                        ? new Date(b.start_date).getTime()
                        : 0;
                    return bDate - aDate;
                });
            };

            const researchProjects = sortProjects(
                researcher.initiatives.filter(
                    (i) => i.initiative_type?.name === "Research Project",
                ),
            );
            const extensionProjects = sortProjects(
                researcher.initiatives.filter(
                    (i) => i.initiative_type?.name === "Extension Project",
                ),
            );
            const developmentProjects = sortProjects(
                researcher.initiatives.filter(
                    (i) => i.initiative_type?.name === "Development Project",
                ),
            );

            const hasProjects =
                researchProjects.length > 0 ||
                extensionProjects.length > 0 ||
                developmentProjects.length > 0;

            if (!hasProjects) {
                return (
                    <p class="text-text-secondary italic">
                        Nenhum projeto registrado.
                    </p>
                );
            }

            return (
                <div class="space-y-10">
                    {/* Research Projects */}
                    {researchProjects.length > 0 && (
                        <div class="space-y-4">
                            <h4 class="text-sm font-bold text-text-secondary uppercase tracking-widest flex items-center gap-2">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4 text-emerald-500"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                </svg>
                                Pesquisa
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                {researchProjects.map((initiative) => (
                                    <ProjectCard initiative={initiative} />
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Extension Projects */}
                    {extensionProjects.length > 0 && (
                        <div class="space-y-4">
                            <h4 class="text-sm font-bold text-text-secondary uppercase tracking-widest flex items-center gap-2">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4 text-purple-500"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                    <circle cx="9" cy="7" r="4" />
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                </svg>
                                Extens√£o
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                {extensionProjects.map((initiative) => (
                                    <ProjectCard initiative={initiative} />
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Development Projects */}
                    {developmentProjects.length > 0 && (
                        <div class="space-y-4">
                            <h4 class="text-sm font-bold text-text-secondary uppercase tracking-widest flex items-center gap-2">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4 text-blue-500"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <polyline points="16 18 22 12 16 6" />
                                    <polyline points="8 6 2 12 8 18" />
                                </svg>
                                Desenvolvimento
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                {developmentProjects.map((initiative) => (
                                    <ProjectCard initiative={initiative} />
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        })()
    }
</section>

{/* Extracted Card Component for reuse within this file contexts */}
{
    /* 
    Ideally this should be a separate component file, but preventing scope creep for now. 
    Definning it here as a variable for render function usage isn't possible in Astro directly inside JSX like React.
    So I duplicated the card above. Wait, I should better duplicate the code or extract a component.
    To avoid duplication in the replace block, I'll assume ProjectCard is not available and I should inline or create it.
    Creating a separate component is cleaner.
    */
}
