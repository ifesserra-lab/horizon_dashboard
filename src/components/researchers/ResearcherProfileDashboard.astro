---
import type { Researcher } from "../../types/researchers";
import BarChart from "../shared/BarChart.astro";
import ArticleYearChart from "./ArticleYearChart.astro";
import AdvisorshipTypeChart from "./AdvisorshipTypeChart.astro";

interface Props {
    researcher: Researcher;
    advisorships: any[]; // Using any to avoid complex type duplication for now, or import properly
}

const { researcher, advisorships } = Astro.props;

// Helper to safely parse date
function getYearFromDate(dateStr: string | undefined | null): number | null {
    if (!dateStr || dateStr === "None") return null;
    try {
        // Handle "YYYY-MM-DD HH:MM:SS.mmmmmm" format commonly found in Lattes
        const cleanDate = dateStr.includes(" ")
            ? dateStr.split(" ")[0]
            : dateStr;
        const year = new Date(cleanDate).getFullYear();
        if (!isNaN(year) && year > 1900 && year < 2100) return year;
    } catch (e) {
        return null; // Silent fail
    }
    return null;
}

// Projects Data Aggregation
const projectYearMap = new Map<number, number>();
if (researcher.initiatives) {
    researcher.initiatives.forEach((p) => {
        const year = getYearFromDate(p.start_date);
        if (year) {
            projectYearMap.set(year, (projectYearMap.get(year) || 0) + 1);
        }
    });
}
const projectData = Array.from(projectYearMap.entries())
    .sort((a, b) => a[0] - b[0])
    .map(([year, count]) => ({ label: year.toString(), value: count }));
---

<section aria-labelledby="dashboard-title" class="space-y-6">
    <div
        class="flex items-center justify-between border-b border-border-main pb-4"
    >
        <h3
            id="dashboard-title"
            class="text-2xl font-bold font-['Outfit'] text-text-main"
        >
            Dashboard
        </h3>
        <!-- Tabs Navigation -->
        <div class="flex space-x-2 bg-card-bg/50 p-1 rounded-xl">
            <button
                class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 text-text-secondary hover:text-text-main hover:bg-white/5 data-[active=true]:bg-premium-purple/20 data-[active=true]:text-premium-purple"
                data-tab="articles"
                data-active="true"
            >
                Artigos
            </button>
            <button
                class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 text-text-secondary hover:text-text-main hover:bg-white/5 data-[active=true]:bg-premium-purple/20 data-[active=true]:text-premium-purple"
                data-tab="projects"
            >
                Projetos
            </button>
            <button
                class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 text-text-secondary hover:text-text-main hover:bg-white/5 data-[active=true]:bg-premium-purple/20 data-[active=true]:text-premium-purple"
                data-tab="advisorships"
            >
                Orientações
            </button>
        </div>
    </div>

    <!-- Tab Content: Articles -->
    <div id="tab-articles" class="tab-content space-y-6">
        <div class="glass-card p-6 border border-border-main rounded-3xl">
            <div class="h-80 w-full">
                <ArticleYearChart
                    articles={researcher.articles}
                    showTitle={false}
                />
            </div>
        </div>
    </div>

    <!-- Tab Content: Projects -->
    <div id="tab-projects" class="tab-content hidden space-y-6">
        <div class="glass-card p-6 border border-border-main rounded-3xl">
            <BarChart
                data={projectData}
                color="emerald-500"
                height="h-64"
                title="Projetos por Ano"
                valueLabel="Projetos"
                showTitle={false}
            />
        </div>
    </div>

    <!-- Tab Content: Advisorships -->
    <div id="tab-advisorships" class="tab-content hidden space-y-6">
        <div class="h-96 w-full">
            <AdvisorshipTypeChart
                advisorships={advisorships}
                showTitle={false}
            />
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Tab Logic
        const tabBtns = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        tabBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                const target = btn.getAttribute("data-tab");

                // Update Buttons
                tabBtns.forEach((b) => b.setAttribute("data-active", "false"));
                btn.setAttribute("data-active", "true");

                // Update Content
                tabContents.forEach((content) => {
                    content.classList.add("hidden");
                    if (content.id === `tab-${target}`) {
                        content.classList.remove("hidden");
                    }
                });
            });
        });
    });
</script>
