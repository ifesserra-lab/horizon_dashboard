---
import Layout from '../../layouts/Layout.astro';
import KpiCard from '../../components/KpiCard.astro';
import knowledgeAreas from '../../data/mart/knowledge_areas_mart.json';

// Get all unique groups to count them correctly
const allGroups = new Set();
knowledgeAreas.forEach(area => {
  area.groups.forEach(group => allGroups.add(group.id));
});

const totalAreas = knowledgeAreas.length;
const totalGroups = allGroups.size;
const avgGroupsPerArea = (totalGroups / totalAreas).toFixed(1);

// Sort areas by group count descending
const sortedAreas = [...knowledgeAreas].sort((a, b) => b.groups_count - a.groups_count);
---

<Layout title="Áreas de Conhecimento">
	<div class="space-y-8">
		<header>
			<h1 class="text-3xl font-['Outfit'] font-bold mb-2">Áreas de Conhecimento</h1>
			<p class="text-text-muted">Distribuição dos grupos de pesquisa por áreas acadêmicas.</p>
		</header>

		<!-- Dashboard Summary -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
			<KpiCard 
				title="Total de Áreas" 
				value={totalAreas.toString()} 
				icon="book"
			/>
			<KpiCard 
				title="Total de Grupos" 
				value={totalGroups.toString()} 
				icon="users"
			/>
			<KpiCard 
				title="Média Grupos/Área" 
				value={avgGroupsPerArea} 
				icon="activity"
			/>
		</div>

		<!-- Areas Grid -->
		<div class="grid grid-cols-1 gap-6">
			{sortedAreas.map((area) => (
				<div class="glass-card p-6 flex flex-col md:flex-row gap-6 group hover:border-premium-accent/30 transition-all">
					<div class="md:w-1/3">
						<div class="flex items-center gap-3 mb-4">
							<div class="w-12 h-12 bg-premium-accent/10 rounded-xl flex items-center justify-center text-premium-accent group-hover:bg-premium-accent group-hover:text-white transition-all">
								<span class="font-bold text-lg">{area.groups_count}</span>
							</div>
							<div>
								<h2 class="text-xl font-bold font-['Outfit']">{area.area_name}</h2>
								<p class="text-xs text-text-muted">{area.campuses.length} Campi envolvidos</p>
							</div>
						</div>
						
						<div class="flex flex-wrap gap-2 mt-2">
							{area.campuses.slice(0, 5).map(campus => (
								<span class="px-2 py-0.5 bg-tag-bg text-[10px] rounded-full border border-border-main text-text-main">{campus}</span>
							))}
							{area.campuses.length > 5 && (
								<span class="px-2 py-0.5 bg-tag-bg text-[10px] rounded-full border border-border-main text-text-main">+{area.campuses.length - 5}</span>
							)}
						</div>
					</div>

					<div class="md:w-2/3 border-t md:border-t-0 md:border-l border-border-main pt-4 md:pt-0 md:pl-6">
						<h3 class="text-sm font-semibold mb-3 text-text-muted flex items-center gap-2">
							<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
							Grupos Vinculados
						</h3>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
							{area.groups.map(group => (
								<a 
									href={`${import.meta.env.BASE_URL}groups/${group.id}`}
									class="text-sm p-3 rounded-lg border border-border-main bg-white/5 hover:bg-premium-accent/5 hover:border-premium-accent/20 transition-all flex flex-col gap-1 group/item"
								>
									<span class="font-medium group-hover/item:text-premium-accent transition-colors line-clamp-1">{group.name}</span>
									<span class="text-[10px] text-text-muted">{group.campus}</span>
								</a>
							))}
						</div>
					</div>
				</div>
			))}
		</div>
	</div>
</Layout>
