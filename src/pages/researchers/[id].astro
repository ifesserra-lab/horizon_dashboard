---
import Layout from "../../layouts/Layout.astro";
import researchersData from "../../data/canonical/researchers_canonical.json";
import advisorshipsData from "../../data/canonical/advisorships_canonical.json";
import type { Researcher } from "../../types/researchers";
import type {
    ProjectAdvisorship,
    AdvisorshipItem,
} from "../../types/advisorships";
import ArticleYearChart from "../../components/researchers/ArticleYearChart.astro";

export function getStaticPaths() {
    const researchers = researchersData as unknown as Researcher[];
    return researchers.map((researcher) => ({
        params: { id: researcher.id.toString() },
        props: { researcher },
    }));
}

interface Props {
    researcher: Researcher;
}

const { researcher } = Astro.props;

// Load and filter advisorships
const allProjects = advisorshipsData as unknown as ProjectAdvisorship[];
const researcherAdvisorships = allProjects
    .flatMap((p) =>
        p.advisorships.map((a) => ({
            ...a,
            projectName: p.name,
            projectId: p.id,
        })),
    )
    .filter(
        (a) =>
            a.supervisor_id === researcher.id || a.student_id === researcher.id,
    )
    .sort((a, b) => {
        if (!a.start_date) return 1;
        if (!b.start_date) return -1;
        return (
            new Date(b.start_date).getTime() - new Date(a.start_date).getTime()
        );
    });

const asSupervisor = researcherAdvisorships.filter(
    (a) => a.supervisor_id === researcher.id,
);
const asStudent = researcherAdvisorships.filter(
    (a) => a.student_id === researcher.id,
);
---

<Layout
    title={researcher.name}
    breadcrumbReplacements={{ [researcher.id]: researcher.name }}
>
    <nav class="mb-8" aria-label="Navegação secundária">
        <a
            href={`${import.meta.env.BASE_URL}researchers`}
            class="text-sm font-bold text-text-secondary hover:text-premium-accent flex items-center gap-2 transition-colors focus:ring-2 focus:ring-premium-accent rounded px-1"
        >
            <svg
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg
            >
            Voltar para lista
        </a>
    </nav>

    <div class="flex flex-col lg:flex-row gap-8 items-start">
        <!-- Main Details -->
        <div class="flex-1 space-y-8 w-full">
            <article class="glass-card p-8" aria-labelledby="researcher-title">
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8"
                >
                    <div class="flex items-center gap-6">
                        <div
                            aria-hidden="true"
                            class="w-20 h-20 rounded-full bg-gradient-to-br from-premium-accent to-premium-purple flex items-center justify-center text-white text-3xl font-bold font-['Outfit'] shadow-xl shadow-premium-accent/10"
                        >
                            {researcher.name.charAt(0)}
                        </div>
                        <div>
                            <h1
                                id="researcher-title"
                                class="text-3xl font-bold font-['Outfit'] text-text-main leading-tight mb-2"
                            >
                                {researcher.name}
                            </h1>
                            {
                                researcher.identification_id && (
                                    <p class="text-sm text-text-secondary flex items-center gap-2">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="w-4 h-4"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <rect
                                                width="20"
                                                height="16"
                                                x="2"
                                                y="4"
                                                rx="2"
                                            />
                                            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                                        </svg>
                                        <a
                                            href={`mailto:${researcher.identification_id}`}
                                            class="hover:text-premium-accent transition-colors"
                                        >
                                            {researcher.identification_id}
                                        </a>
                                    </p>
                                )
                            }
                        </div>
                    </div>

                    <div class="flex gap-3">
                        {
                            researcher.cnpq_url && (
                                <a
                                    href={researcher.cnpq_url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="px-4 py-2 bg-[var(--tag-bg)] hover:bg-premium-accent/10 border border-border-main rounded-xl text-xs font-bold transition-all flex items-center gap-2 text-text-main focus:ring-2 focus:ring-premium-accent"
                                >
                                    Currículo Lattes
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-4 h-4"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                        <polyline points="15 3 21 3 21 9" />
                                        <line x1="10" y1="14" x2="21" y2="3" />
                                    </svg>
                                </a>
                            )
                        }
                        {
                            researcher.google_scholar_url && (
                                <a
                                    href={researcher.google_scholar_url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="px-4 py-2 bg-[var(--tag-bg)] hover:bg-premium-purple/10 border border-border-main rounded-xl text-xs font-bold transition-all flex items-center gap-2 text-text-main focus:ring-2 focus:ring-premium-purple"
                                >
                                    Google Scholar
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-4 h-4"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                        <polyline points="15 3 21 3 21 9" />
                                        <line x1="10" y1="14" x2="21" y2="3" />
                                    </svg>
                                </a>
                            )
                        }
                    </div>
                </div>

                <div>
                    <h4
                        class="text-text-main text-sm font-bold uppercase tracking-wider mb-4"
                    >
                        Áreas de Conhecimento
                    </h4>
                    <div
                        class="flex flex-wrap gap-3"
                        role="list"
                        aria-label="Áreas de atuação"
                    >
                        {
                            researcher.knowledge_areas.map((area) => (
                                <div
                                    role="listitem"
                                    class="px-4 py-2 bg-[var(--tag-bg)] border border-border-main rounded-xl text-xs text-text-main font-bold"
                                >
                                    {area.name}
                                </div>
                            ))
                        }
                        {
                            researcher.knowledge_areas.length === 0 && (
                                <p class="text-text-secondary text-sm italic">
                                    Nenhuma área registrada.
                                </p>
                            )
                        }
                    </div>
                </div>
            </article>

            {/* Resume Section */}
            {
                researcher.resume && (
                    <section
                        aria-labelledby="cv-summary-title"
                        class="space-y-6"
                    >
                        <h3
                            id="cv-summary-title"
                            class="text-2xl font-bold font-['Outfit'] text-text-main py-4 border-b border-border-main"
                        >
                            Resumo do Currículo
                        </h3>
                        <div class="glass-card p-6">
                            <p class="text-text-main text-sm leading-relaxed">
                                {researcher.resume}
                            </p>
                        </div>
                    </section>
                )
            }

            {/* Academic Education Section */}
            {
                researcher.academic_education &&
                    researcher.academic_education.length > 0 && (
                        <section
                            aria-labelledby="education-title"
                            class="space-y-6"
                        >
                            <h3
                                id="education-title"
                                class="text-2xl font-bold font-['Outfit'] text-text-main py-4 border-b border-border-main"
                            >
                                Formação Acadêmica
                            </h3>
                            <div class="space-y-4">
                                {researcher.academic_education.map((edu) => (
                                    <div class="glass-card p-5 border-l-4 border-l-premium-accent hover:bg-premium-accent/[0.02] transition-all">
                                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-2 mb-4">
                                            <span class="text-xs font-bold text-premium-accent uppercase tracking-wider bg-premium-accent/10 px-2 py-0.5 rounded w-fit">
                                                {edu.degree}
                                            </span>
                                            <div class="flex items-center gap-2 text-xs text-text-secondary">
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="w-3.5 h-3.5"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                >
                                                    <rect
                                                        width="18"
                                                        height="18"
                                                        x="3"
                                                        y="4"
                                                        rx="2"
                                                        ry="2"
                                                    />
                                                    <line
                                                        x1="16"
                                                        x2="16"
                                                        y1="2"
                                                        y2="6"
                                                    />
                                                    <line
                                                        x1="8"
                                                        x2="8"
                                                        y1="2"
                                                        y2="6"
                                                    />
                                                    <line
                                                        x1="3"
                                                        x2="21"
                                                        y1="10"
                                                        y2="10"
                                                    />
                                                </svg>
                                                <span class="font-medium">
                                                    {edu.start_year} -{" "}
                                                    {edu.end_year}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="flex items-start gap-2 mb-3">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            >
                                                <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                                                <path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5" />
                                            </svg>
                                            <h4 class="font-bold text-text-main">
                                                {edu.institution}
                                            </h4>
                                        </div>

                                        <div class="space-y-2 text-sm">
                                            <div class="flex items-start gap-2">
                                                <span class="text-xs font-bold text-text-secondary uppercase tracking-wide min-w-[70px]">
                                                    Curso:
                                                </span>
                                                <span class="text-text-main">
                                                    {edu.course_name}
                                                </span>
                                            </div>
                                            {edu.thesis_title && (
                                                <div class="flex items-start gap-2">
                                                    <span class="text-xs font-bold text-text-secondary uppercase tracking-wide min-w-[70px]">
                                                        Título:
                                                    </span>
                                                    <span class="text-text-main italic">
                                                        {edu.thesis_title}
                                                    </span>
                                                </div>
                                            )}
                                            {edu.advisor_name && (
                                                <div class="flex items-start gap-2">
                                                    <span class="text-xs font-bold text-text-secondary uppercase tracking-wide min-w-[70px]">
                                                        Orientador:
                                                    </span>
                                                    <span class="text-text-main">
                                                        {edu.advisor_name}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )
            }

            <!-- Research Groups -->
            <section aria-labelledby="groups-title" class="space-y-6">
                <h3
                    id="groups-title"
                    class="text-2xl font-bold font-['Outfit'] text-text-main py-4 border-b border-border-main"
                >
                    Grupos de Pesquisa
                </h3>

                {
                    researcher.research_groups.length > 0 ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {researcher.research_groups.map((group) => (
                                <a
                                    href={`${import.meta.env.BASE_URL}groups/${group.id}`}
                                    class="glass-card p-5 group hover:border-premium-accent/40 transition-all flex items-center gap-4"
                                >
                                    <div class="w-12 h-12 rounded-xl bg-[var(--tag-bg)] flex items-center justify-center text-premium-accent font-bold group-hover:bg-premium-accent group-hover:text-white transition-colors shrink-0">
                                        {group.name.charAt(0)}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-text-main group-hover:text-premium-accent transition-colors line-clamp-2 text-sm">
                                            {group.name}
                                        </h4>
                                        <span class="text-[10px] text-text-secondary uppercase tracking-wider font-bold">
                                            Ver grupo
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>
                    ) : (
                        <p class="text-text-secondary italic">
                            Não está vinculado a nenhum grupo de pesquisa
                            registrado.
                        </p>
                    )
                }
            </section>

            <!-- Initiatives -->
            <section aria-labelledby="projects-title" class="space-y-6">
                <h3
                    id="projects-title"
                    class="text-2xl font-bold font-['Outfit'] text-text-main py-4 border-b border-border-main"
                >
                    Projetos e Iniciativas
                </h3>

                {
                    researcher.initiatives.length > 0 ? (
                        <div class="grid grid-cols-1 gap-4">
                            {researcher.initiatives.map((initiative) => (
                                <div class="glass-card p-5 flex flex-col md:flex-row md:items-center justify-between gap-4 hover:border-premium-accent/20 transition-all">
                                    <div>
                                        <div class="flex items-center gap-3 mb-2">
                                            <span
                                                class={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border ${initiative.status === "active" ? "bg-emerald-500/10 text-emerald-600 border-emerald-500/20" : "bg-slate-100 text-slate-500 border-slate-200"}`}
                                            >
                                                {initiative.status}
                                            </span>
                                            <span class="text-[10px] text-text-secondary font-bold uppercase tracking-wider">
                                                {initiative.role}
                                            </span>
                                        </div>
                                        <h4 class="font-bold text-text-main text-lg">
                                            {initiative.name}
                                        </h4>
                                    </div>
                                    <a
                                        href={`${import.meta.env.BASE_URL}projects/${initiative.id}`}
                                        class="px-4 py-2 rounded-lg bg-[var(--tag-bg)] hover:bg-premium-accent text-text-secondary hover:text-white text-xs font-bold transition-all text-center self-start md:self-center shrink-0"
                                    >
                                        Ver Projeto
                                    </a>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p class="text-text-secondary italic">
                            Nenhum projeto registrado.
                        </p>
                    )
                }
            </section>

            <!-- Advisorships -->
            <section
                aria-labelledby="advisorships-title"
                class="space-y-8 pb-10"
            >
                <h3
                    id="advisorships-title"
                    class="text-2xl font-bold font-['Outfit'] text-text-main py-4 border-b border-border-main"
                >
                    Orientações
                </h3>

                {
                    researcherAdvisorships.length > 0 ? (
                        <div class="space-y-10">
                            {asSupervisor.length > 0 && (
                                <div class="space-y-4">
                                    <h4 class="text-sm font-bold text-text-secondary uppercase tracking-widest flex items-center gap-2">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="w-4 h-4"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                            <circle cx="9" cy="7" r="4" />
                                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                        </svg>
                                        Como Orientador
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {asSupervisor.map((adv) => (
                                            <div class="glass-card p-5 border-l-4 border-l-premium-accent group hover:bg-premium-accent/[0.02] transition-all">
                                                <div class="flex justify-between items-start mb-3">
                                                    <span class="text-[10px] font-bold text-premium-accent uppercase tracking-wider bg-premium-accent/10 px-2 py-0.5 rounded">
                                                        {adv.fellowship?.name ||
                                                            "Sem Bolsa"}
                                                    </span>
                                                    <span class="text-[10px] font-medium text-text-secondary">
                                                        {adv.start_date
                                                            ? new Date(
                                                                  adv.start_date,
                                                              ).getFullYear()
                                                            : "N/A"}
                                                    </span>
                                                </div>
                                                <h5 class="font-bold text-text-main mb-2 leading-snug truncate-2-lines group-hover:text-premium-accent transition-colors">
                                                    {adv.name}
                                                </h5>
                                                <div class="flex flex-col gap-1">
                                                    <p class="text-xs text-text-secondary">
                                                        <span class="font-bold text-text-main">
                                                            Estudante:
                                                        </span>{" "}
                                                        {adv.student_name}
                                                    </p>
                                                    <p class="text-xs text-text-secondary italic">
                                                        {adv.projectName}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {asStudent.length > 0 && (
                                <div class="space-y-4">
                                    <h4 class="text-sm font-bold text-text-secondary uppercase tracking-widest flex items-center gap-2">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="w-4 h-4"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                        </svg>
                                        Como Orientando
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {asStudent.map((adv) => (
                                            <div class="glass-card p-5 border-l-4 border-l-premium-purple group hover:bg-premium-purple/[0.02] transition-all">
                                                <div class="flex justify-between items-start mb-3">
                                                    <span class="text-[10px] font-bold text-premium-purple uppercase tracking-wider bg-premium-purple/10 px-2 py-0.5 rounded">
                                                        {adv.fellowship?.name ||
                                                            "Sem Bolsa"}
                                                    </span>
                                                    <span class="text-[10px] font-medium text-text-secondary">
                                                        {adv.start_date
                                                            ? new Date(
                                                                  adv.start_date,
                                                              ).getFullYear()
                                                            : "N/A"}
                                                    </span>
                                                </div>
                                                <h5 class="font-bold text-text-main mb-2 leading-snug truncate-2-lines group-hover:text-premium-purple transition-colors">
                                                    {adv.name}
                                                </h5>
                                                <div class="flex flex-col gap-1">
                                                    <p class="text-xs text-text-secondary">
                                                        <span class="font-bold text-text-main">
                                                            Orientador:
                                                        </span>{" "}
                                                        {adv.supervisor_name}
                                                    </p>
                                                    <p class="text-xs text-text-secondary italic">
                                                        {adv.projectName}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <p class="text-text-secondary italic">
                            Nenhuma orientação registrada.
                        </p>
                    )
                }
            </section>
            <!-- Articles Section -->
            <section aria-labelledby="articles-title" class="space-y-6 pb-20">
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between gap-4 py-4 border-b border-border-main"
                >
                    <h3
                        id="articles-title"
                        class="text-2xl font-bold font-['Outfit'] text-text-main"
                    >
                        Artigos Científicos
                    </h3>
                    <div class="relative w-full md:w-80">
                        <input
                            type="text"
                            id="articleSearch"
                            placeholder="Buscar artigos..."
                            class="w-full bg-glass-bg border border-border-main rounded-xl px-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-premium-purple/50 focus:border-premium-purple transition-all text-text-main"
                        />
                        <svg
                            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-text-secondary"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <circle cx="11" cy="11" r="8"></circle><path
                                d="m21 21-4.3-4.3"></path>
                        </svg>
                    </div>
                </div>

                <div class="h-64 mb-8">
                    <ArticleYearChart
                        articles={researcher.articles}
                        showTitle={false}
                    />
                </div>

                <div id="articlesList" class="space-y-4">
                    {/* Articles will be injected here by client-side script */}
                </div>

                <!-- Infinite Scroll Indicators -->
                <div
                    id="loadMoreSentinel"
                    class="h-10 w-full flex items-center justify-center"
                >
                    <div
                        id="loadingSpinner"
                        class="hidden animate-spin rounded-full h-8 w-8 border-4 border-premium-purple border-t-transparent"
                    >
                    </div>
                </div>
                <div
                    id="allLoadedMessage"
                    class="hidden text-center text-text-secondary text-sm py-4 italic"
                >
                    Todos os artigos foram carregados.
                </div>
                <div id="noArticlesFound" class="hidden text-center py-12">
                    <p class="text-text-secondary italic">
                        Nenhum artigo encontrado para esta busca.
                    </p>
                </div>
            </section>
        </div>
    </div>
</Layout>

<script define:vars={{ researcher }}>
    // Provide articles data to client-side
    window.researcherArticles = researcher.articles || [];
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const articlesList = document.getElementById("articlesList");
        const articleSearch = document.getElementById(
            "articleSearch",
        ) as HTMLInputElement;
        const spinner = document.getElementById("loadingSpinner");
        const sentinel = document.getElementById("loadMoreSentinel");
        const allLoadedMsg = document.getElementById("allLoadedMessage");
        const noArticlesMsg = document.getElementById("noArticlesFound");

        let allArticles = (window as any).researcherArticles || [];
        let filteredArticles = [...allArticles];
        let displayedCount = 0;
        const BATCH_SIZE = 30;
        let observer: IntersectionObserver | null = null;

        function updateUI() {
            if (
                filteredArticles.length === 0 &&
                (articleSearch.value.trim() !== "" || allArticles.length === 0)
            ) {
                noArticlesMsg?.classList.remove("hidden");
                allLoadedMsg?.classList.add("hidden");
            } else {
                noArticlesMsg?.classList.add("hidden");
            }
        }

        function loadMoreArticles() {
            const nextBatch = filteredArticles.slice(
                displayedCount,
                displayedCount + BATCH_SIZE,
            );

            nextBatch.forEach((article) => {
                const articleEl = document.createElement("div");
                articleEl.className =
                    "glass-card p-5 border border-border-main hover:border-premium-purple/30 transition-all";
                articleEl.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="space-y-2">
                             <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded-md bg-premium-purple/10 text-premium-purple text-[10px] font-bold uppercase tracking-wider">
                                    ${article.type || "ARTIGO"}
                                </span>
                                <span class="text-xs font-bold text-text-secondary">${article.year}</span>
                            </div>
                            <h4 class="text-sm font-bold text-text-main leading-snug">${article.title}</h4>
                            <p class="text-xs text-text-secondary flex items-center gap-1.5 italic">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                ${article.journal_conference}
                            </p>
                        </div>
                        ${
                            article.doi
                                ? `
                            <a href="${article.doi.startsWith("http") ? article.doi : `https://doi.org/${article.doi}`}" 
                               target="_blank" 
                               class="flex-shrink-0 p-2 bg-premium-purple/5 hover:bg-premium-purple/10 rounded-lg text-premium-purple transition-colors"
                               title="Ver DOI">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                            </a>
                        `
                                : ""
                        }
                    </div>
                `;
                articlesList?.appendChild(articleEl);
            });

            displayedCount += batchesToLoad(nextBatch.length);
            displayedCount = Math.min(displayedCount, filteredArticles.length);

            function batchesToLoad(len: number) {
                return len;
            }

            if (
                displayedCount >= filteredArticles.length &&
                filteredArticles.length > 0
            ) {
                allLoadedMsg?.classList.remove("hidden");
                if (observer) observer.disconnect();
            } else {
                allLoadedMsg?.classList.add("hidden");
            }
        }

        function setupInfiniteScroll() {
            if (observer) observer.disconnect();

            observer = new IntersectionObserver(
                (entries) => {
                    if (
                        entries[0].isIntersecting &&
                        displayedCount < filteredArticles.length
                    ) {
                        spinner?.classList.remove("hidden");
                        setTimeout(() => {
                            loadMoreArticles();
                            spinner?.classList.add("hidden");
                        }, 400);
                    }
                },
                { threshold: 0.1 },
            );

            if (sentinel) observer.observe(sentinel);
        }

        function handleSearch() {
            const query = articleSearch.value.toLowerCase().trim();
            filteredArticles = allArticles.filter(
                (a: any) =>
                    a.title.toLowerCase().includes(query) ||
                    a.journal_conference.toLowerCase().includes(query),
            );

            displayedCount = 0;
            articlesList!.innerHTML = "";
            updateUI();
            loadMoreArticles();
            setupInfiniteScroll();
        }

        articleSearch?.addEventListener("input", handleSearch);

        // Initial Load
        updateUI();
        loadMoreArticles();
        setupInfiniteScroll();
    });
</script>
