---
import Layout from "../../layouts/Layout.astro";
import researchersData from "../../data/canonical/researchers_canonical.json";
import advisorshipsData from "../../data/canonical/advisorships_canonical.json";
import initiativesData from "../../data/canonical/initiatives_canonical.json";
import type { Researcher } from "../../types/researchers";
import type { ProjectAdvisorship } from "../../types/advisorships";

// Profile Components
import ResearcherProfileHeader from "../../components/researchers/ResearcherProfileHeader.astro";
import ResearcherProfileEducation from "../../components/researchers/ResearcherProfileEducation.astro";
import ResearcherProfileResume from "../../components/researchers/ResearcherProfileResume.astro";
import ResearcherProfileDashboard from "../../components/researchers/ResearcherProfileDashboard.astro";
import ResearcherProfileGroups from "../../components/researchers/ResearcherProfileGroups.astro";
import ResearcherProfileInitiatives from "../../components/researchers/ResearcherProfileInitiatives.astro";
import ResearcherProfileAdvisorships from "../../components/researchers/ResearcherProfileAdvisorships.astro";
import ResearcherProfileArticles from "../../components/researchers/ResearcherProfileArticles.astro";
import ResearcherProfileStats from "../../components/researchers/ResearcherProfileStats.astro";

export function getStaticPaths() {
    const researchers = researchersData as unknown as Researcher[];
    return researchers.map((researcher) => ({
        params: { id: researcher.id.toString() },
        props: { researcher },
    }));
}

interface Props {
    researcher: Researcher;
}

const { researcher } = Astro.props;

// Enrich initiatives with start_date from canonical source
const enrichedInitiatives = researcher.initiatives.map((init) => {
    const fullInit = (initiativesData as any[]).find((i) => i.id === init.id);
    return {
        ...init,
        start_date: fullInit?.start_date,
        end_date: fullInit?.end_date,
        initiative_type: fullInit?.initiative_type,
    };
});

// Update researcher object with enriched initiatives
const enrichedResearcher = {
    ...researcher,
    initiatives: enrichedInitiatives,
};

// Load and filter advisorships
const allProjects = advisorshipsData as unknown as ProjectAdvisorship[];
const researcherAdvisorships = allProjects
    .flatMap((p) =>
        p.advisorships.map((a) => ({
            ...a,
            projectName: p.name,
            projectId: p.id,
        })),
    )
    .filter(
        (a) =>
            a.supervisor_id === researcher.id || a.student_id === researcher.id,
    )
    .sort((a, b) => {
        if (!a.start_date) return 1;
        if (!b.start_date) return -1;
        return (
            new Date(b.start_date).getTime() - new Date(a.start_date).getTime()
        );
    });

const asSupervisor = researcherAdvisorships.filter(
    (a) => a.supervisor_id === researcher.id,
);
const asStudent = researcherAdvisorships.filter(
    (a) => a.student_id === researcher.id,
);
---

<Layout
    title={researcher.name}
    breadcrumbReplacements={{ [researcher.id]: researcher.name }}
>
    <nav class="mb-8" aria-label="NavegaÃ§Ã£o secundÃ¡ria">
        <!-- Back button removed -->
    </nav>

    <div class="flex flex-col lg:flex-row gap-8 items-start">
        <div class="flex-1 space-y-8 w-full">
            <ResearcherProfileHeader researcher={enrichedResearcher} />
            <ResearcherProfileResume researcher={enrichedResearcher} />

            <ResearcherProfileStats
                totalArticles={enrichedResearcher.articles.length}
                totalProjects={enrichedResearcher.initiatives.length}
                totalAdvisorships={asSupervisor.length}
            />

            <ResearcherProfileDashboard
                researcher={enrichedResearcher}
                advisorships={asSupervisor}
            />

            <ResearcherProfileEducation researcher={enrichedResearcher} />
            <ResearcherProfileGroups researcher={enrichedResearcher} />
            <ResearcherProfileInitiatives researcher={enrichedResearcher} />
            <ResearcherProfileAdvisorships
                asSupervisor={asSupervisor}
                asStudent={asStudent}
            />

            <ResearcherProfileArticles researcher={enrichedResearcher} />
        </div>
    </div>
</Layout>
