---
import Layout from '../../layouts/Layout.astro';
import projectsData from '../../data/canonical/initiatives_canonical.json';
import type { Project } from '../../types/projects';

export function getStaticPaths() {
  const projects = projectsData as Project[];
  return projects.map(project => ({
    params: { id: project.id.toString() },
    props: { project },
  }));
}

interface Props {
  project: Project;
}

const { project } = Astro.props;

const formatDate = (dateStr: string) => {
	if (!dateStr) return 'N/A';
	const date = new Date(dateStr);
	return date.toLocaleDateString('pt-BR', {
		day: '2-digit',
		month: '2-digit',
		year: 'numeric'
	});
};

const statusStyles = {
	active: 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20',
	concluded: 'bg-slate-500/10 text-slate-500 border-slate-500/20',
};

const currentStatusStyle = statusStyles[project.status as keyof typeof statusStyles] || 'bg-premium-accent/10 text-premium-accent border-premium-accent/20';
---

<Layout title={project.name} breadcrumbReplacements={{ [project.id]: project.name }}>
	<nav class="mb-8" aria-label="Navegação secundária">
		<a href={`${import.meta.env.BASE_URL}projects`} class="text-sm font-bold text-text-secondary hover:text-premium-accent flex items-center gap-2 transition-colors focus:ring-2 focus:ring-premium-accent rounded px-1">
			<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
			Voltar para lista
		</a>
	</nav>

	<div class="flex flex-col lg:flex-row gap-8 items-start">
		<div class="flex-1 space-y-8 w-full">
			<article class="glass-card p-8" aria-labelledby="project-title">
				<div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
					<div class="flex items-center gap-6">
						<div aria-hidden="true" class="w-20 h-20 rounded-2xl bg-gradient-to-br from-premium-accent to-premium-purple flex items-center justify-center text-white p-4 shadow-xl shadow-premium-accent/10 shrink-0">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A5 5 0 0 0 8 8c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
						</div>
						<div>
							<h1 id="project-title" class="text-2xl md:text-3xl font-bold font-['Outfit'] text-text-main leading-tight">{project.name}</h1>
						</div>
					</div>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10 pt-8 border-t border-border-main">
					<div>
						<h4 class="text-text-main text-sm font-bold uppercase tracking-wider mb-3">Período de Execução</h4>
						<div class="flex items-center gap-3 text-text-secondary">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
							<span class="text-base font-semibold text-text-main">
								{formatDate(project.start_date)} — {formatDate(project.end_date)}
							</span>
						</div>
					</div>
					<div>
						<h4 class="text-text-main text-sm font-bold uppercase tracking-wider mb-3">Identificação</h4>
						<div class="flex items-center gap-3 text-text-secondary">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
							<span class="text-base font-semibold text-text-main">ID: {project.id}</span>
						</div>
					</div>
				</div>

				{project.description && (
					<div class="prose dark:prose-invert max-w-none">
						<h4 class="text-text-main text-sm font-bold uppercase tracking-wider mb-3">Sobre o Projeto</h4>
						<p class="text-text-secondary leading-relaxed whitespace-pre-wrap">
							{project.description}
						</p>
					</div>
				)}
			</article>

			<!-- Members Section -->
			<section aria-labelledby="members-title" class="space-y-10">
				<div>
					<h3 id="members-title" class="text-2xl font-bold font-['Outfit'] text-text-main mb-6">Equipe do Projeto</h3>
					
					{/* Researchers Section */}
					{(project.team?.filter(m => m.roles.includes('Researcher') && !m.roles.includes('Coordinator')) || []).length > 0 && (
						<div class="mb-12">
							<h4 class="text-lg font-bold text-text-main mb-6 flex items-center gap-2">
								<span class="w-1.5 h-6 bg-premium-accent/60 rounded-full"></span>
								Pesquisadores
							</h4>

							{/* Current Researchers */}
							{project.team?.filter(m => m.roles.includes('Researcher') && !m.roles.includes('Coordinator') && !m.end_date).length > 0 && (
								<div class="mb-8">
									<h5 class="text-xs font-bold uppercase tracking-widest text-text-secondary mb-4 px-1">Atuais</h5>
									<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
										{project.team
											.filter(m => m.roles.includes('Researcher') && !m.roles.includes('Coordinator') && !m.end_date)
											.map(member => (
											<div class="glass-card p-4 flex items-center gap-4 transition-all hover:border-premium-accent/30">
												<div aria-hidden="true" class="w-12 h-12 rounded-full bg-[var(--tag-bg)] border-2 border-border-main flex items-center justify-center text-text-secondary font-bold shrink-0 relative">
													{member.person_name.charAt(0)}
												</div>
												<div class="flex-1 overflow-hidden">
													<div class="flex items-center gap-2">
														<h5 class="text-sm font-bold text-text-main truncate">{member.person_name}</h5>
													</div>
													<p class="text-[10px] font-bold uppercase tracking-tight text-text-secondary">
														Pesquisador
													</p>
												</div>
											</div>
										))}
									</div>
								</div>
							)}

							{/* Alumni Researchers */}
							{project.team?.filter(m => m.roles.includes('Researcher') && !m.roles.includes('Coordinator') && m.end_date).length > 0 && (
								<div>
									<h5 class="text-xs font-bold uppercase tracking-widest text-text-secondary mb-4 px-1">Egressos</h5>
									<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
										{project.team
											.filter(m => m.roles.includes('Researcher') && !m.roles.includes('Coordinator') && m.end_date)
											.map(member => (
											<div class="glass-card p-4 flex items-center gap-4 transition-all opacity-70 grayscale hover:grayscale-0 hover:opacity-100 hover:border-slate-400">
												<div aria-hidden="true" class="w-12 h-12 rounded-full bg-[var(--tag-bg)] border-2 border-border-main flex items-center justify-center text-text-secondary font-bold shrink-0 relative">
													{member.person_name.charAt(0)}
													<span class="absolute -bottom-1 -right-1 w-4 h-4 bg-slate-500 rounded-full border-2 border-[var(--tag-bg)] flex items-center justify-center" title="Egresso">
														<svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
													</span>
												</div>
												<div class="flex-1 overflow-hidden">
													<div class="flex items-center gap-2">
														<h5 class="text-sm font-bold text-text-main truncate">{member.person_name}</h5>
														<span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase bg-slate-100 dark:bg-slate-800 text-slate-500 border border-slate-200 dark:border-slate-700">Egresso</span>
													</div>
													<p class="text-[10px] font-bold uppercase tracking-tight text-text-secondary">
														Pesquisador
													</p>
												</div>
											</div>
										))}
									</div>
								</div>
							)}
						</div>
					)}

					{/* Students Section */}
					{(project.team?.filter(m => m.roles.includes('Student')) || []).length > 0 && (
						<div class="mb-12">
							<h4 class="text-lg font-bold text-text-main mb-6 flex items-center gap-2">
								<span class="w-1.5 h-6 bg-premium-purple rounded-full"></span>
								Estudantes
							</h4>

							{/* Current Students */}
							{project.team?.filter(m => m.roles.includes('Student') && !m.end_date).length > 0 && (
								<div class="mb-8">
									<h5 class="text-xs font-bold uppercase tracking-widest text-text-secondary mb-4 px-1">Atuais</h5>
									<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
										{project.team
											.filter(m => m.roles.includes('Student') && !m.end_date)
											.map(member => (
											<div class="glass-card p-4 flex items-center gap-4 transition-all hover:border-premium-purple/30">
												<div aria-hidden="true" class="w-12 h-12 rounded-full bg-[var(--tag-bg)] border-2 border-border-main flex items-center justify-center text-text-secondary font-bold shrink-0 relative">
													{member.person_name.charAt(0)}
												</div>
												<div class="flex-1 overflow-hidden">
													<div class="flex items-center gap-2">
														<h5 class="text-sm font-bold text-text-main truncate">{member.person_name}</h5>
													</div>
													<p class="text-[10px] font-bold uppercase tracking-tight text-text-secondary">
														Estudante
													</p>
												</div>
											</div>
										))}
									</div>
								</div>
							)}

							{/* Alumni Students */}
							{project.team?.filter(m => m.roles.includes('Student') && m.end_date).length > 0 && (
								<div>
									<h5 class="text-xs font-bold uppercase tracking-widest text-text-secondary mb-4 px-1">Egressos</h5>
									<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
										{project.team
											.filter(m => m.roles.includes('Student') && m.end_date)
											.map(member => (
											<div class="glass-card p-4 flex items-center gap-4 transition-all opacity-70 grayscale hover:grayscale-0 hover:opacity-100 hover:border-slate-400">
												<div aria-hidden="true" class="w-12 h-12 rounded-full bg-[var(--tag-bg)] border-2 border-border-main flex items-center justify-center text-text-secondary font-bold shrink-0 relative">
													{member.person_name.charAt(0)}
													<span class="absolute -bottom-1 -right-1 w-4 h-4 bg-slate-500 rounded-full border-2 border-[var(--tag-bg)] flex items-center justify-center" title="Egresso">
														<svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
													</span>
												</div>
												<div class="flex-1 overflow-hidden">
													<div class="flex items-center gap-2">
														<h5 class="text-sm font-bold text-text-main truncate">{member.person_name}</h5>
														<span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase bg-slate-100 dark:bg-slate-800 text-slate-500 border border-slate-200 dark:border-slate-700">Egresso</span>
													</div>
													<p class="text-[10px] font-bold uppercase tracking-tight text-text-secondary">
														Estudante
													</p>
												</div>
											</div>
										))}
									</div>
								</div>
							)}
						</div>
					)}
				</div>
			</section>
		</div>

		<aside class="w-full lg:w-80 space-y-6">
			{/* Leadership Section */}
			{project.team?.filter(m => m.roles.includes('Coordinator')).length > 0 && (
				<section class="bg-gradient-to-br from-premium-accent/10 to-premium-purple/10 border border-premium-accent/20 rounded-3xl p-6 backdrop-blur-md" aria-labelledby="leadership-title">
					<h4 id="leadership-title" class="text-text-main font-bold mb-4">Liderança</h4>
					<div class="space-y-4">
						{project.team
							?.filter(m => m.roles.includes('Coordinator'))
							.map(leader => (
							<div class="flex items-center gap-3 p-3 bg-white/30 dark:bg-white/5 rounded-2xl border border-border-main shadow-sm transition-all hover:bg-white/40 dark:hover:bg-white/10">
								<div aria-hidden="true" class="w-10 h-10 rounded-full bg-premium-accent flex items-center justify-center text-white font-bold text-sm">
									{leader.person_name.charAt(0)}
								</div>
								<div class="overflow-hidden">
									<p class="text-xs font-bold text-text-main truncate text-pretty">{leader.person_name}</p>
									<p class="text-[10px] text-premium-accent font-bold">Coordenador</p>
								</div>
							</div>
						))}
					</div>
				</section>
			)}

			<section class="glass-card p-6" aria-labelledby="additional-info-title">
				<h4 id="additional-info-title" class="text-text-main font-bold mb-4">Informações Adicionais</h4>
				<div class="space-y-4">
					<div class="flex justify-between text-xs items-center">
						<span class="text-text-secondary font-bold text-left">Status</span>
						<span class={`px-2 py-0.5 rounded-full font-bold uppercase tracking-wider text-[10px] ${
							(project.status === 'active' || project.status === 'ativo') 
								? 'bg-green-500/10 text-green-500 border border-green-500/20' 
								: 'bg-slate-500/10 text-text-secondary border border-border-main'
						}`}>
							{project.status === 'active' || project.status === 'ativo' ? 'Ativo' : (project.status === 'concluded' || project.status === 'concluído' ? 'Concluído' : project.status)}
						</span>
					</div>
					<div class="flex justify-between text-xs">
						<span class="text-text-secondary font-bold text-left">Tipo</span>
						<span class="text-text-main font-bold text-right italic">
							{project.initiative_type?.name === 'Research Project' ? 'Projeto de pesquisa' : (project.initiative_type?.name || 'Projeto de pesquisa')}
						</span>
					</div>
				</div>
			</section>
		</aside>
	</div>
</Layout>
