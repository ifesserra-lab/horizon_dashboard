---
import Layout from '../../layouts/Layout.astro';
import groupsData from '../../data/canonical/research_groups_canonical.json';
import type { ResearchGroup } from '../../types/groups';

const groups = (groupsData as ResearchGroup[]).sort((a, b) => a.name.localeCompare(b.name));
---

<Layout title="Grupos de Pesquisa">
	<header class="mb-10">
		<div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
			<div>
				<h2 class="text-3xl font-bold font-['Outfit'] text-text-main">Grupos de Pesquisa</h2>
				<p class="text-text-secondary mt-2">Explore os grupos ativos e suas áreas de atuação.</p>
			</div>
			
			<div class="relative max-w-md w-full">
				<label for="groupSearch" class="sr-only">Buscar grupos de pesquisa</label>
				<input 
					type="text" 
					id="groupSearch"
					placeholder="Buscar por nome, campus, líder ou área..." 
					class="w-full bg-glass-bg border border-border-main rounded-2xl px-12 py-4 text-sm focus:outline-none focus:ring-2 focus:ring-premium-accent/50 focus:border-premium-accent transition-all text-text-main shadow-lg shadow-premium-accent/5"
				/>
				<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
				
				<button id="resetFilters" class="absolute right-4 top-1/2 -translate-y-1/2 text-text-secondary hover:text-premium-accent transition-colors hidden" title="Limpar busca">
					<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 9-6 6"/><path d="m9 9 6 6"/><circle cx="12" cy="12" r="10"/></svg>
				</button>
			</div>
		</div>
	</header>

	<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="groupsGrid" role="region" aria-label="Catálogo de grupos">
		{groups.map(group => (
			<article 
				class="group-card glass-card p-6 hover:border-premium-accent/40 hover:bg-premium-accent/[0.02] transition-all flex flex-col"
				data-name={group.name.toLowerCase()}
				data-campus={group.campus.name.toLowerCase()}
				data-areas={group.knowledge_areas.map(ka => ka.name.toLowerCase()).join('|')}
				data-leaders={group.leaders.map(l => l.name.toLowerCase()).join('|')}
			>
				<div class="flex items-start justify-between mb-4">
					<div aria-hidden="true" class="w-12 h-12 rounded-xl bg-gradient-to-br from-premium-accent/10 to-premium-purple/10 border border-border-main flex items-center justify-center text-premium-accent font-bold overflow-hidden text-xs text-center p-1 leading-tight">
						{group.short_name || group.name.charAt(0)}
					</div>
					<span class="px-3 py-1 rounded-full bg-[var(--tag-bg)] text-[10px] font-bold text-text-secondary uppercase tracking-wider border border-border-main">
						{group.campus.name}
					</span>
				</div>
				
				<h3 class="text-lg font-bold text-text-main mb-2 leading-tight group-hover:text-premium-accent transition-colors">
					{group.name}
				</h3>
				<p class="text-sm text-text-secondary line-clamp-2 mb-6 flex-1">
					{group.description || "Sem descrição disponível."}
				</p>

				<div class="flex flex-wrap gap-2 mb-6" aria-label="Áreas de conhecimento">
					{group.knowledge_areas.slice(0, 2).map(area => (
						<span class="px-2 py-0.5 rounded-md bg-[var(--tag-bg)] text-[10px] font-bold text-text-secondary border border-border-main">
							{area.name}
						</span>
					))}
					{group.knowledge_areas.length > 2 && (
						<span class="px-2 py-0.5 rounded-md bg-[var(--tag-bg)] text-[10px] font-bold text-text-secondary">
							+{group.knowledge_areas.length - 2}
						</span>
					)}
				</div>

				<div class="pt-6 border-t border-border-main flex justify-end items-center mt-auto">
					<a href={`${import.meta.env.BASE_URL}groups/${group.id}`} class="text-xs font-bold text-premium-accent flex items-center gap-1 hover:translate-x-1 transition-transform focus:ring-2 focus:ring-premium-accent rounded px-1" aria-label={`Detalhes de ${group.name}`}>
						Detalhes
						<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
					</a>
				</div>
			</article>
		))}
	</div>

	<!-- Empty State -->
	<div id="emptyState" class="hidden flex-col items-center justify-center py-24 text-center">
		<div class="w-24 h-24 bg-slate-100 dark:bg-white/5 rounded-3xl flex items-center justify-center mb-6 text-text-secondary border border-border-main border-dashed">
			<svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/><path d="M8 11h6"/></svg>
		</div>
		<h3 class="text-2xl font-bold font-['Outfit'] text-text-main mb-2">Sem resultados</h3>
		<p class="text-text-secondary max-w-sm">
			Não encontramos nenhum grupo que corresponda à sua busca. Tente pesquisar por outro nome, campus ou área.
		</p>
	</div>

	<script>
		const searchInput = document.getElementById('groupSearch') as HTMLInputElement;
		const resetBtn = document.getElementById('resetFilters');
		const emptyState = document.getElementById('emptyState');
		const groupCards = document.querySelectorAll('.group-card');

		function filterGroups() {
			const query = searchInput.value.toLowerCase().trim();
			let visibleCount = 0;

			// Show/hide reset button
			if (query) {
				resetBtn?.classList.remove('hidden');
			} else {
				resetBtn?.classList.add('hidden');
			}

			groupCards.forEach(card => {
				const element = card as HTMLElement;
				const name = element.dataset.name || '';
				const campus = element.dataset.campus || '';
				const areas = element.dataset.areas || '';
				const leaders = element.dataset.leaders || '';
				
				const matches = !query || 
					name.includes(query) || 
					campus.includes(query) ||
					areas.includes(query) || 
					leaders.includes(query);

				if (matches) {
					element.style.display = 'flex';
					visibleCount++;
				} else {
					element.style.display = 'none';
				}
			});

			// Toggle empty state
			if (visibleCount === 0) {
				emptyState?.classList.remove('hidden');
				emptyState?.classList.add('flex');
			} else {
				emptyState?.classList.add('hidden');
				emptyState?.classList.remove('flex');
			}
		}

		searchInput?.addEventListener('input', filterGroups);
		
		resetBtn?.addEventListener('click', () => {
			searchInput.value = '';
			filterGroups();
			searchInput.focus();
		});
	</script>
</Layout>

