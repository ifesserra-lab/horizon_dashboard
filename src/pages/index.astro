---
import Layout from '../layouts/Layout.astro';
import KpiCard from '../components/KpiCard.astro';
import groupsData from '../data/canonical/research_groups_canonical.json';
import knowledgeAreasMart from '../data/mart/knowledge_areas_mart.json';
import type { ResearchGroup } from '../types/groups';

const groups = groupsData as ResearchGroup[];

const totalGroups = groups.length;
const totalMembers = groups.reduce((acc, g) => acc + (g.members?.length || 0), 0);
const totalCampus = new Set(groups.map(g => g.campus.id)).size;
const totalKnowledgeAreas = new Set(groups.flatMap(g => g.knowledge_areas.map(ka => ka.id))).size;

const icons = {
  groups: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  members: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  campus: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
  areas: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>'
};

// Calculate Top 10 Research Lines (Linhas de Pesquisa)
// We filter out broad area names defined in the mart data
const broadAreaNames = new Set(knowledgeAreasMart.map(a => a.area_name));

const lineCounts: Record<string, number> = {};
groups.forEach(g => {
	g.knowledge_areas.forEach(ka => {
		if (!broadAreaNames.has(ka.name)) {
			lineCounts[ka.name] = (lineCounts[ka.name] || 0) + 1;
		}
	});
});

const top10Lines = Object.entries(lineCounts)
	.sort(([, a], [, b]) => b - a)
	.slice(0, 10)
	.map(([line, count]) => ({
		name: line,
		count,
		percentage: (count / groups.length) * 100
	}));
---

<Layout title="Dashboard Overview">
	<header class="mb-10">
		<h2 class="text-3xl font-bold font-['Outfit'] text-text-main text-balance">Bem-vindo ao Horizon</h2>
		<p class="text-text-secondary mt-2 max-w-2xl">
			Sua plataforma central para explorar o horizonte de <strong>pesquisa</strong>, <strong>extensão</strong> e <strong>pós-graduação</strong> da nossa instituição.
		</p>
	</header>

	<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12" role="region" aria-label="Métricas principais">
		<KpiCard title="Total de Grupos" value={totalGroups} icon={icons.groups} />
		<KpiCard title="Pesquisadores" value={totalMembers} icon={icons.members} color="premium-purple" />
		<KpiCard title="Campus" value={totalCampus} icon={icons.campus} color="text-secondary" />
		<KpiCard title="Áreas de Conhecimento" value={totalKnowledgeAreas} icon={icons.areas} color="premium-accent" />
	</div>

	<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

		<!-- Statistics and Areas -->
		<section class="glass-card p-6" aria-labelledby="distribution-title">
			<h3 id="distribution-title" class="text-xl font-bold font-['Outfit'] text-text-main mb-6">Top 10 Áreas de Conhecimento</h3>
			<div class="flex flex-col gap-5">
				{top10Lines.map((line) => (
					<div class="space-y-1.5">
						<div class="flex justify-between text-[10px] font-bold">
							<span class="text-text-main truncate max-w-[70%]" title={line.name}>{line.name}</span>
							<span class="text-text-secondary">{line.count} grupos</span>
						</div>
						<div class="w-full h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
							<div class="h-full bg-gradient-to-r from-premium-accent to-premium-purple rounded-full" style={`width: ${Math.min(line.percentage * 5, 100)}%`}></div>
						</div>
					</div>
				))}
			</div>
		</section>
	</div>
</Layout>
