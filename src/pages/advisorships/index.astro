---
import Layout from "../../layouts/Layout.astro";
import advisorshipsData from "../../data/canonical/advisorships_canonical.json";
import AdvisorshipKpiCards from "../../components/advisorships/AdvisorshipKpiCards.astro";
import AdvisorshipCharts from "../../components/advisorships/AdvisorshipCharts.astro";
import AdvisorshipCard from "../../components/AdvisorshipCard.astro";
import type {
    ProjectAdvisorship,
    AdvisorshipItem,
} from "../../types/advisorships";

// Cast data
const allProjects = advisorshipsData as unknown as ProjectAdvisorship[];

// Flatten all advisorships for the explorer
const allAdvisorships = allProjects
    .flatMap((project) =>
        (project.advisorships || []).map((adv) => ({
            ...adv,
            projectName: project.name,
        })),
    )
    .filter(Boolean);

// Sort by start date (if available)
const sortedAdvisorships = [...allAdvisorships].sort((a, b) => {
    if (!a.start_date) return 1;
    if (!b.start_date) return -1;
    return new Date(b.start_date).getTime() - new Date(a.start_date).getTime();
});

// Extract Filters Data
const uniqueFellowships = [
    ...new Set(
        allAdvisorships
            .map((a) => a.fellowship?.name)
            .filter(Boolean) as string[],
    ),
].sort();

const uniqueYears = [
    ...new Set(
        allAdvisorships
            .map((a) =>
                a.start_date
                    ? new Date(a.start_date.replace(" ", "T"))
                          .getFullYear()
                          .toString()
                    : null,
            )
            .filter(Boolean) as string[],
    ),
].sort((a, b) => b.localeCompare(a)); // Descending years

// Calculate Summary Data
const uniqueStudents = new Set(allAdvisorships.map((a) => a.student_id)).size;
const uniqueSupervisors = new Set(allAdvisorships.map((a) => a.supervisor_id))
    .size;

const activeAdvisorships = allAdvisorships.filter(
    (a) => a.status?.toLowerCase() === "active",
).length;

const concludedAdvisorships = allAdvisorships.filter(
    (a) => a.status?.toLowerCase() === "concluded",
).length;

const fellowshipsCount = allAdvisorships.filter(
    (a) => a.fellowship && a.fellowship.name,
).length;

const summary = {
    total_advisorships: allAdvisorships.length,
    active_advisorships: activeAdvisorships,
    concluded_advisorships: concludedAdvisorships, // Added this field
    total_fellowships: fellowshipsCount,
    unique_students: uniqueStudents,
    unique_supervisors: uniqueSupervisors,
};

// Calculate Analytics
const statusColors = {
    active: "var(--color-premium-accent, #38bdf8)",
    concluded: "var(--color-text-muted, #94a3b8)",
    unknown: "#f59e0b",
};

const statusCounts = allAdvisorships.reduce((acc: any, curr) => {
    const status = (curr.status || "unknown").toLowerCase();
    acc[status] = (acc[status] || 0) + 1;
    return acc;
}, {});

const statusDistribution = Object.entries(statusCounts).map(
    ([label, value]) => ({
        label: label.charAt(0).toUpperCase() + label.slice(1),
        value: value as number,
        color: statusColors[label as keyof typeof statusColors] || "#e2e8f0",
    }),
);

const fellowshipCounts = allAdvisorships
    .filter((a) => a.fellowship)
    .reduce((acc: any, curr) => {
        const name = curr.fellowship?.name || "Outras";
        acc[name] = (acc[name] || 0) + 1;
        return acc;
    }, {});

const fellowshipColors = [
    "#0ea5e9",
    "#8b5cf6",
    "#ec4899",
    "#f59e0b",
    "#10b981",
    "#6366f1",
];
const fellowshipDistribution = Object.entries(fellowshipCounts)
    .sort((a: any, b: any) => b[1] - a[1])
    .map(([label, value], i) => ({
        label,
        value: value as number,
        color: fellowshipColors[i % fellowshipColors.length],
    }));

const supervisorCounts = allAdvisorships.reduce((acc: any, curr) => {
    const name = curr.supervisor_name;
    if (!name || name === "None") return acc;
    acc[name] = (acc[name] || 0) + 1;
    return acc;
}, {});

const topSupervisors = Object.entries(supervisorCounts)
    .sort((a: any, b: any) => b[1] - a[1])
    .slice(0, 10)
    .map(([name, count]) => ({
        name: name as string,
        count: count as number,
    }));

// Fellowship Evolution (Line Chart Data)
const minYearCalculated = Math.min(
    ...allAdvisorships
        .map((a) =>
            a.start_date ? new Date(a.start_date).getFullYear() : 9999,
        )
        .filter((y) => y !== 9999),
);

// Limit to last 10 years as requested by user
const currentYear = new Date().getFullYear();
const startYearLimit = currentYear - 9;
const minYear = Math.max(minYearCalculated, startYearLimit);

const yearRange = Array.from(
    { length: currentYear - minYear + 1 },
    (_, i) => minYear + i,
);

const fellowshipEvolution = uniqueFellowships.map((fName, i) => {
    const data = yearRange.map((year) => {
        const count = allAdvisorships.filter((a) => {
            if (a.fellowship?.name !== fName) return false;
            if (!a.start_date) return false;

            const start = new Date(a.start_date).getFullYear();
            const end = a.end_date
                ? new Date(a.end_date).getFullYear()
                : currentYear;

            return year >= start && year <= end;
        }).length;
        return { year, value: count };
    });
    return {
        label: fName,
        data,
        color: fellowshipColors[i % fellowshipColors.length],
    };
});

const fellowshipFinancialEvolution = uniqueFellowships.map((fName, i) => {
    const data = yearRange.map((year) => {
        const total = allAdvisorships
            .filter((a) => {
                if (a.fellowship?.name !== fName) return false;
                if (!a.start_date) return false;

                const start = new Date(a.start_date).getFullYear();
                const end = a.end_date
                    ? new Date(a.end_date).getFullYear()
                    : currentYear;

                return year >= start && year <= end;
            })
            .reduce((acc, curr) => {
                const val = parseFloat(String(curr.fellowship?.value || "0"));
                return acc + val;
            }, 0);
        return { year, value: total };
    });
    return {
        label: fName,
        data,
        color: fellowshipColors[i % fellowshipColors.length],
    };
});

const analytics = {
    status_distribution: statusDistribution,
    fellowship_distribution: fellowshipDistribution,
    fellowship_evolution: fellowshipEvolution,
    fellowship_financial_evolution: fellowshipFinancialEvolution,
    top_supervisors: topSupervisors,
};
---

<Layout title="Gestão de Orientações | Horizon">
    <div class="space-y-8 max-w-[1600px] mx-auto pb-12">
        <!-- Header Section -->
        <div
            class="flex flex-col md:flex-row md:items-end justify-between gap-6"
        >
            <div class="space-y-2">
                <div class="flex items-center gap-2 text-premium-accent mb-2">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="m15 18-6-6 6-6"></path></svg
                    >
                    <a
                        href="/horizon_dashboard/"
                        class="text-xs font-bold uppercase tracking-widest hover:text-premium-accent/80 transition-colors"
                        >Dashboard</a
                    >
                </div>
                <h1
                    class="text-4xl md:text-5xl font-bold font-['Outfit'] text-text-main tracking-tight"
                >
                    Gestão de <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-premium-accent to-premium-purple"
                        >Orientações</span
                    >
                </h1>
                <p class="text-text-muted text-lg max-w-2xl">
                    Análise detalhada de estudantes, bolsistas e orientadores do
                    Laboratório IFES-Serra.
                </p>
            </div>

            <div class="flex items-center gap-4">
                <div class="glass-card px-4 py-2 flex items-center gap-3">
                    <span
                        class="w-2 h-2 rounded-full bg-premium-accent animate-pulse"
                    ></span>
                    <span class="text-sm font-bold text-text-secondary"
                        >{allAdvisorships.length} Registros</span
                    >
                </div>
            </div>
        </div>

        <AdvisorshipKpiCards summary={summary} />

        <!-- Analytics Section -->
        <div class="grid grid-cols-1 gap-8">
            <AdvisorshipCharts analytics={analytics} />
        </div>

        <!-- Filters and List Section -->
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold font-['Outfit'] text-text-main">
                    Explorador de Orientações
                </h2>
            </div>

            <div class="glass-card p-6">
                <!-- Advanced Filters -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="space-y-2">
                        <label
                            class="text-xs font-bold text-text-muted uppercase tracking-wider"
                            >Busca</label
                        >
                        <div class="relative group">
                            <input
                                type="text"
                                id="search-input"
                                placeholder="Nome do aluno ou orientador..."
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-text-main placeholder:text-text-muted focus:outline-none focus:border-premium-accent/50 focus:bg-white/10 transition-all pl-10"
                            />
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-premium-accent transition-colors"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><circle cx="11" cy="11" r="8"></circle><path
                                    d="m21 21-4.3-4.3"></path></svg
                            >
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label
                            class="text-xs font-bold text-text-muted uppercase tracking-wider"
                            >Status</label
                        >
                        <select
                            id="status-filter"
                            class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-text-main focus:outline-none focus:border-premium-accent/50 focus:bg-white/10 transition-all appearance-none cursor-pointer"
                        >
                            <option value="all">Todos os Status</option>
                            <option value="active">Ativas</option>
                            <option value="concluded">Concluídas</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label
                            class="text-xs font-bold text-text-muted uppercase tracking-wider"
                            >Tipo de Bolsa</label
                        >
                        <select
                            id="fellowship-filter"
                            class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-text-main focus:outline-none focus:border-premium-accent/50 focus:bg-white/10 transition-all appearance-none cursor-pointer"
                        >
                            <option value="all">Todas as Bolsas</option>
                            {
                                uniqueFellowships.map((f) => (
                                    <option value={f}>{f}</option>
                                ))
                            }
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label
                            class="text-xs font-bold text-text-muted uppercase tracking-wider"
                            >Ano de Início</label
                        >
                        <select
                            id="year-filter"
                            class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-text-main focus:outline-none focus:border-premium-accent/50 focus:bg-white/10 transition-all appearance-none cursor-pointer"
                        >
                            <option value="all">Todos os Anos</option>
                            {
                                uniqueYears.map((y) => (
                                    <option value={y}>{y}</option>
                                ))
                            }
                        </select>
                    </div>
                </div>

                <div
                    id="advisorships-grid"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
                >
                    {
                        sortedAdvisorships.map((advisorship) => (
                            <div class="advisorship-item-wrapper transition-all duration-500 hover:scale-[1.02]">
                                <AdvisorshipCard advisorship={advisorship} />
                            </div>
                        ))
                    }
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden py-20 text-center">
                    <div
                        class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 text-text-muted"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><circle cx="11" cy="11" r="8"></circle><path
                                d="m21 21-4.3-4.3"></path></svg
                        >
                    </div>
                    <h3 class="text-xl font-bold text-text-main mb-2">
                        Nenhuma orientação encontrada
                    </h3>
                    <p class="text-text-muted">
                        Tente ajustar seus filtros para encontrar o que procura.
                    </p>
                </div>

                <!-- Load More / Counter -->
                <div class="mt-12 flex flex-col items-center gap-4">
                    <p
                        class="text-sm text-text-muted font-medium"
                        id="counter-text"
                    >
                        Mostrando {sortedAdvisorships.length} de {
                            sortedAdvisorships.length
                        } orientações
                    </p>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script is:inline define:vars={{ initialAdvisorships: sortedAdvisorships }}>
    // Re-initialize logic for filtering
    const searchInput = document.getElementById("search-input");
    const statusFilter = document.getElementById("status-filter");
    const fellowshipFilter = document.getElementById("fellowship-filter");
    const yearFilter = document.getElementById("year-filter");
    const grid = document.getElementById("advisorships-grid");
    const emptyState = document.getElementById("empty-state");
    const counterText = document.getElementById("counter-text");
    const items = document.querySelectorAll(".advisorship-item-wrapper");

    function filter() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusTerm = statusFilter.value.toLowerCase();
        const fellowshipTerm = fellowshipFilter.value.toLowerCase();
        const yearTerm = yearFilter.value.toLowerCase();

        let visibleCount = 0;

        items.forEach((item, index) => {
            const data = initialAdvisorships[index];
            const studentName = (data.student_name || "").toLowerCase();
            const supervisorName = (data.supervisor_name || "").toLowerCase();
            const projectName = (data.projectName || "").toLowerCase();
            const status = (data.status || "").toLowerCase();
            const fellowship = (data.fellowship?.name || "").toLowerCase();
            const year = data.start_date
                ? new Date(data.start_date.replace(" ", "T"))
                      .getFullYear()
                      .toString()
                : "";

            const matchesSearch =
                studentName.includes(searchTerm) ||
                supervisorName.includes(searchTerm) ||
                projectName.includes(searchTerm);
            const matchesStatus = statusTerm === "all" || status === statusTerm;
            const matchesFellowship =
                fellowshipTerm === "all" || fellowship === fellowshipTerm;
            const matchesYear = yearTerm === "all" || year === yearTerm;

            if (
                matchesSearch &&
                matchesStatus &&
                matchesFellowship &&
                matchesYear
            ) {
                item.style.display = "block";
                visibleCount++;
            } else {
                item.style.display = "none";
            }
        });

        if (visibleCount === 0) {
            grid.classList.add("hidden");
            emptyState.classList.remove("hidden");
        } else {
            grid.classList.remove("hidden");
            emptyState.classList.add("hidden");
        }

        counterText.textContent = `Mostrando ${visibleCount} de ${initialAdvisorships.length} orientações`;
    }

    searchInput.addEventListener("input", filter);
    statusFilter.addEventListener("change", filter);
    fellowshipFilter.addEventListener("change", filter);
    yearFilter.addEventListener("change", filter);
</script>

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        transition: all 0.3s ease;
    }

    .glass-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }
</style>
